<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin_layout}">
<head>
    <title th:text="${titulo}"></title>
    <style>
        .card{
            border-radius:10px;
            box-shadow:0 2px 6px rgba(0,0,0,.08);
            overflow:hidden;
        }
        .card-header{
            background: linear-gradient(135deg, #0062cc, #004085);
            color:#fff;
            font-weight:700;
            text-transform:uppercase;
            padding:15px;
        }
        .toolbar{
            display:flex;
            flex-wrap:wrap;
            gap:.5rem;
            align-items:center;
            padding: .75rem 1rem 0 1rem;
        }
        .nav-tabs .nav-link{
            color: #0062cc;
            font-weight: 600;
        }
        .nav-tabs .nav-link.active{
            background: linear-gradient(135deg, #0062cc, #004085);
            color: #fff;
            border-color: #0062cc;
        }
        .nav-tabs .nav-link:hover{
            border-color: #0062cc;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="container-fluid px-2 px-md-3">
        <section class="content-header">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-edit mr-2"></i> <span th:text="${titulo}"></span>
                </div>

                <div class="toolbar">
                    <a th:href="@{/citas/listar}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list mr-1"></i> Listado de Citas
                    </a>
                    <a th:href="@{/pedidos/listarPedidos}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-tasks mr-1"></i> Listado de Trabajos
                    </a>
                    <a th:href="@{/listar}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-user mr-1"></i> Clientes
                    </a>
                </div>

                <div class="card-body mt-3">
                    <!-- Nav Tabs -->
                    <ul class="nav nav-tabs" id="citaTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="cita-tab" data-toggle="tab" href="#cita" role="tab" aria-controls="cita" aria-selected="true">
                                <i class="fas fa-calendar-plus mr-1"></i> Cita
                            </a>
                        </li>
                        <li class="nav-item" th:if="${historial != null and !historial.empty}">
                            <a class="nav-link" id="historial-tab" data-toggle="tab" href="#historial" role="tab" aria-controls="historial" aria-selected="false">
                                <i class="fas fa-history mr-1"></i> Historial 
                                <span class="badge badge-info ml-1" th:text="${historial.size()}"></span>
                            </a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="citaTabContent">
                        <!-- Tab Cita -->
                        <div class="tab-pane fade show active" id="cita" role="tabpanel" aria-labelledby="cita-tab">
                            <form th:action="@{/citas/form}" th:object="${cita}" method="post">
                                <input type="hidden" th:field="*{id}" />

                        <div class="row">
                            <!-- Cliente -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Cliente</label>
                                    <select th:if="${cita.id == null and cita.cliente == null}" th:field="*{cliente}" class="form-control" required>
                                        <option value="">-- Seleccionar Cliente --</option>
                                        <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre + ' ' + c.apellido}"></option>
                                    </select>
                                    <div th:if="${cita.id != null or cita.cliente != null}">
                                        <input type="text" class="form-control" 
                                               th:value="${cita.cliente.nombre + ' ' + cita.cliente.apellido}" disabled />
                                        <input type="hidden" name="cliente" th:value="${cita.cliente.id}" />
                                    </div>
                                </div>
                            </div>

                            <!-- Pedido Asociado (si existe) -->
                            <div class="col-md-6" th:if="${cita.pedido != null}">
                                <div class="form-group">
                                    <label>Pedido Asociado</label>
                                    <input type="text" class="form-control" th:value="'Ref #' + ${cita.pedido.ref}" disabled />
                                    <input type="hidden" name="pedido" th:value="${cita.pedido.npedido}" />
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Fecha y Hora -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="fechaCita">Fecha y Hora</label>
                                    <input type="datetime-local" th:field="*{fechaCita}" class="form-control" id="fechaCita" required />
                                    <small class="form-text text-danger" th:if="${#fields.hasErrors('fechaCita')}" th:errors="*{fechaCita}"></small>
                                </div>
                            </div>

                            <!-- Tipo de Cita -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Tipo de Cita</label>
                                    <select th:field="*{tipo}" class="form-control" required>
                                        <option th:each="t : ${tipos}" th:value="${t}" th:text="${t}"></option>
                                    </select>
                                </div>
                            </div>

                            <!-- Estado -->
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Estado</label>
                                    <select th:field="*{estado}" class="form-control" required>
                                        <option th:each="e : ${estados}" th:value="${e}" th:text="${e}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Observaciones -->
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="observacion">Observaciones / Detalles del trabajo</label>
                                    <textarea th:field="*{observacion}" class="form-control" id="observacion" rows="3" placeholder="Ej: Trae anillo para ensanchar..."></textarea>
                                </div>
                            </div>
                        </div>

                                <div class="card-footer bg-transparent border-top-0 px-0">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save mr-1"></i> Guardar Cita
                                    </button>
                                    <a th:href="${clienteId != null ? '/ver/' + clienteId : '/citas/listar'}" class="btn btn-secondary">
                                        <i class="fas fa-times mr-1"></i> Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>

                        <!-- Tab Historial -->
                        <div class="tab-pane fade" id="historial" role="tabpanel" aria-labelledby="historial-tab" th:if="${historial != null and !historial.empty}">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Fecha Modificación</th>
                                            <th>Fecha Cita</th>
                                            <th>Tipo</th>
                                            <th>Estado</th>
                                            <th>Observación</th>
                                            <th>Modificado Por</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="h : ${historial}">
                                            <td>
                                                <small class="text-muted">
                                                    <i class="far fa-clock mr-1"></i>
                                                    <span th:text="${#temporals.format(h.fechaModificacion, 'dd/MM/yyyy HH:mm')}"></span>
                                                </small>
                                            </td>
                                            <td th:text="${#temporals.format(h.fechaCita, 'dd/MM/yyyy HH:mm')}"></td>
                                            <td>
                                                <span th:if="${h.tipo != null and h.tipo.name() == 'ENTREGA_TRABAJO'}" class="badge badge-info">Entrega</span>
                                                <span th:if="${h.tipo != null and h.tipo.name() == 'RECOGIDA_PEDIDO'}" class="badge badge-success">Recogida</span>
                                            </td>
                                            <td>
                                                <span th:if="${h.estado != null}"
                                                      th:classappend="${h.estado.name() == 'PROGRAMADA' ? 'badge-primary' : 
                                                                      (h.estado.name() == 'COMPLETADA' ? 'badge-success' : 
                                                                      (h.estado.name() == 'CANCELADA' ? 'badge-danger' : 'badge-warning'))}"
                                                      class="badge" th:text="${h.estado}"></span>
                                            </td>
                                            <td>
                                                <small th:text="${h.observacion != null ? h.observacion : '-'}"></small>
                                            </td>
                                            <td>
                                                <span class="badge badge-secondary" th:text="${h.usuarioModificacion}"></span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </div>
</div>

</body>
</html>
