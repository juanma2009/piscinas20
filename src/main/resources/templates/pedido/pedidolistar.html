<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="admin/admin_layout">

<head>
    <meta charset="utf-8"/>
    <title>Listar Pedidos</title>

    <link rel="stylesheet" href="../css/table.css">
    <!-- AdminLTE CSS puedes dejarlo si NO estÃ¡ ya en el layout; si ya estÃ¡ en admin/shared/style, quÃ­talo -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <script th:inline="javascript">
        /*<![CDATA[*/
        var tiposPorPieza = /*[[${tiposPorPieza}]]*/ {};
        /*]]>*/
    </script>

    <style>
        /* âœ… No toques html/body aquÃ­ (lo controla el layout) */

        .card{
            border-radius:10px;
            box-shadow:0 2px 6px rgba(0,0,0,.08);
            overflow:hidden;
        }
        .card-header{
            background: linear-gradient(135deg, #0062cc, #004085);
            color:#fff;
            font-weight:700;
            text-transform:uppercase;
            padding:15px;
        }

        /* âœ… Toolbar responsive */
        .toolbar{
            display:flex;
            flex-wrap:wrap;
            gap:.5rem;
            align-items:center;
            padding: .75rem 1rem 0 1rem;
        }


        /* âœ… Filtros: toggle con altura real */
        #formBusqueda{
            overflow:hidden;
            max-height:0;
            transition:max-height .3s ease-in-out;
            margin-top:.75rem;
        }

        /* âœ… Tabla: dentro de mÃ¡rgenes + scroll si hace falta */
        .table-responsive{
            width:100%;
            overflow-x:auto;
            -webkit-overflow-scrolling:touch;
        }
        .dataTables_wrapper{
            width:100%;
            overflow-x:auto;
        }

        table.dataTable{ width:100% !important; }

        .table td, .table th{
            white-space:nowrap;
            font-size:14px;
            padding:8px;
        }

        /* âœ… En mÃ³vil: evita botones gigantes si en el layout hay reglas globales */
        @media (max-width: 768px) {
            .toolbar .btn { width:auto !important; }
        }

        .dataTables_wrapper .dataTables_length {
            margin: 0 !important;
            padding: 0 !important;
        }

        .dataTables_wrapper .dataTables_length label {
            margin: 0 !important;
            display: inline-flex !important;
            align-items: center;
            gap: .25rem;
            font-size: .9rem;
        }

        .dataTables_wrapper .dataTables_length select {
            margin: 0 !important;
            padding: 0 .35rem !important;
            height: 28px !important;
            line-height: 28px !important;
            width: auto !important;
        }

        .dataTables_wrapper .row {
            margin-top: .25rem !important;
            margin-bottom: .25rem !important;
        }
        .dt-actions{
            display: inline-flex;
            gap: .35rem;
            flex-wrap: wrap;
        }


    </style>
</head>

<div layout:fragment="content">
    <div class="container-fluid px-2 px-md-3">

        <section class="content-header">
            <div class="card">

                <div class="card-header">
                    <i class="fas fa-list mr-2"></i> Listado de Trabajos
                </div>

                <div class="toolbar">
                    <a th:href="@{/pedidos/listarFotosPedidos}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-images mr-1"></i> GalerÃ­a
                    </a>
                    <a th:href="@{/listar}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-user mr-1"></i> Clientes
                    </a>
                    <a th:href="@{/form}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-user-plus mr-1"></i> Nuevo Cliente
                    </a>

                    <button type="button" class="btn btn-outline-primary btn-sm" id="toggleBusqueda">
                        Mostrar Filtros
                    </button>
                </div>

                <div class="card-body">

                    <form id="formBusqueda" method="post" th:action="@{'/api/pedido/buscar'}" class="row">
                        <div class="col-12 col-md-0 col-lg-3 mb-2">
                            <label for="cliente" class="form-label">Cliente</label>
                            <select id="cliente" name="cliente" class="form-control">
                                <option value="">Seleccione</option>
                                <option th:each="cliente : ${clientes}"
                                        th:value="${cliente.id}"
                                        th:text="${#strings.concat(cliente.nombre, ' ', cliente.apellido)}"
                                        th:selected="${cliente.id == clienteSeleccionado}">
                                </option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2">
                            <label for="servicios" class="form-label">T.Pedido</label>
                            <select id="servicios" name="servicios" class="form-control">
                                <option value="">Seleccione</option>
                                <option th:each="s : ${servicios}" th:value="${s}" th:text="${s}"></option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2">
                            <label for="estado" class="form-label">Estado</label>
                            <select id="estado" name="estado" class="form-control">
                                <option value="">Seleccione</option>
                                <option th:each="e : ${estados}" th:value="${e}" th:text="${e}"></option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2">
                            <label for="metal" class="form-label">Metal</label>
                            <select id="metal" name="metal" class="form-control">
                                <option value="">Seleccione</option>
                                <option th:each="m : ${metales}" th:value="${m}" th:text="${m}"></option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2">
                            <label for="pieza" class="form-label">Pieza</label>
                            <select id="pieza" name="pieza" class="form-control">
                                <option value="" disabled selected>Seleccione una pieza</option>
                                <option th:each="pieza : ${tiposPorPieza.keySet()}"
                                        th:value="${pieza}" th:text="${pieza}">
                                </option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2">
                            <label for="tipo" class="form-label">Tipo</label>
                            <select id="tipo" class="form-control" name="tipo">
                                <option value="" disabled selected>Seleccione una pieza primero</option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2">
                            <label for="ref" class="form-label">Referencia</label>
                            <input type="text" id="ref" name="ref" class="form-control" placeholder="Ej: ABC123">
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2">
                            <label for="fechaDesde" class="form-label">Fecha Desde</label>
                            <input type="date" id="fechaDesde" name="fechaDesde" class="form-control" th:value="${fechaDesde}">
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2">
                            <label for="fechaHasta" class="form-label">Fecha Hasta</label>
                            <input type="date" id="fechaHasta" name="fechaHasta" class="form-control" th:value="${fechaHasta}">
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2" th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
                            <label for="activo" class="form-label">Ver pedidos</label>
                            <select class="form-control" id="activo" name="activo">
                                <option value="true" selected>Activos</option>
                                <option value="false">Dados de baja</option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6 col-lg-3 mb-2" th:unless="${#authorization.expression('hasRole(''ADMIN'')')}">
                            <label class="form-label">Ver pedidos</label>
                            <div class="form-control-plaintext">Activos</div>
                        </div>

                        <div class="col-12 d-flex justify-content-end mt-0 pb-3" style="gap:.10rem;">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-search mr-1"></i> Buscar
                            </button>
                            <button type="reset" class="btn btn-secondary btn-sm">
                                <i class="fas fa-undo mr-1"></i> Limpiar
                            </button>
                        </div>
                    </form>

                    <div class="table-responsive mt-0">
                        <table class="table table-striped table-bordered datatable w-100"
                               id="table"
                               data-dt="manual">

                        <thead class="table-dark">
                            <tr></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                </div>
            </div>
        </section>

    </div>
</div>

<!-- scripts del page -->
<div layout:fragment="script">
    <script>
        (function () {

            // ========= Helpers =========
            function normalizeRows(response) {
                // por si llega como texto (headers raros / redirect)
                if (typeof response === "string") {
                    try { response = JSON.parse(response); } catch (e) { response = {}; }
                }

                return (
                    (response && Array.isArray(response.data) && response.data) ||
                    (response && response.pedido && Array.isArray(response.pedido.content) && response.pedido.content) ||
                    (Array.isArray(response) && response) ||
                    []
                );
            }

            function closeFilters() {
                const $form = $("#formBusqueda");
                const $btn  = $("#toggleBusqueda");
                if (!$form.length) return;

                $form.css("max-height", "0px").data("open", false);
                $btn.text("Mostrar Filtros");
            }

            function openFilters() {
                const $form = $("#formBusqueda");
                const $btn  = $("#toggleBusqueda");
                if (!$form.length) return;

                $form.css("max-height", $form[0].scrollHeight + "px").data("open", true);
                $btn.text("Ocultar Filtros");
            }

            function ensureFiltersInitialState() {
                const $form = $("#formBusqueda");
                if (!$form.length) return;
                $form.css("max-height", "0px").data("open", false);
                $("#toggleBusqueda").text("Mostrar Filtros");
            }

            function finalizeTableVisuals(selector) {
                const $t = $(selector);
                $t.addClass("dt-ready"); // evita â€œgordo â†’ finoâ€ si usas visibility hidden
                if ($.fn.DataTable && $.fn.DataTable.isDataTable(selector)) {
                    $(selector).DataTable().columns.adjust();
                }
                if (window.finalizeManualDT) window.finalizeManualDT(selector);
            }

                    // ========= DataTable init =========
            const DT_BREAKPOINT = 1560; // ðŸ‘ˆ desde 1560px hacia abajo = responsive
            const isTabletOrLess = () => window.matchMedia(`(max-width:${DT_BREAKPOINT}px)`).matches;

            let lastCompactMode = null; // recuerda si estÃ¡bamos en modo responsive o no

            function initPedidosDT(force = false) {
                const $table = $("#table");
                if (!$table.length || !$.fn.DataTable) return;

                const compact = isTabletOrLess(); // âœ… boolean REAL

                // âœ… Si no ha cambiado el modo y ya existe DT, no reinicies
                if (!force && $.fn.DataTable.isDataTable("#table") && lastCompactMode === compact) {
                    // solo ajusta por si acaso
                    $("#table").DataTable().columns.adjust();
                    return;
                }

                lastCompactMode = compact;

                // âœ… destruir bien si existe
                if ($.fn.DataTable.isDataTable("#table")) {
                    $("#table").DataTable().clear().destroy();
                    $("#table thead tr").empty(); // tu thead es <tr></tr>
                    $("#table tbody").empty();
                }

                // ---------- columnas base (las reales) ----------
                const baseColumns = [
                    { data: "ref",        title: "NÂ° Referencia" },
                    { data: "cliente",    title: "Cliente" },
                    { data: "tipoPedido", title: "T.Pedido" },
                    { data: "estado",     title: "Estado" },

                    {
                        data: "fechaEntrega", title: "F.Entrega",
                        render: function (data) {
                            if (!data) return "";
                            const f = new Date(data);
                            return `${String(f.getDate()).padStart(2,'0')}-${String(f.getMonth()+1).padStart(2,'0')}-${f.getFullYear()}`;
                        }
                    },
                    {
                        data: "fechaFinalizado", title: "F.Finalizado",
                        render: function (data) {
                            if (!data) return "";
                            const f = new Date(data);
                            return `${String(f.getDate()).padStart(2,'0')}-${String(f.getMonth()+1).padStart(2,'0')}-${f.getFullYear()}`;
                        }
                    },

                    { data: "metal",   title: "Metal" },
                    { data: "pieza",   title: "Pieza" },
                    { data: "tipo",    title: "Tipo" },
                    { data: "cobrado", title: "Cobrado" },

                    {
                        data: "npedido", title: "Acciones",
                        orderable: false, searchable: false,
                        render: function (data, type, row) {
                            const ref = row.ref || "sin ref";
                            const cliente = row.cliente || "";
                            const npedido = row.npedido || data;

                            const activo = row.activo;
                            const isActivo = (activo !== false && activo !== "false");

                            const btnEditar = isActivo
                                ? `<a href="/pedidos/formEditar/${npedido}" class="btn btn-warning btn-sm" title="Editar"><i class="fas fa-pencil-alt"></i></a>`
                                : `<button class="btn btn-secondary btn-sm" disabled title="No se puede editar"><i class="fas fa-pencil-alt"></i></button>`;

                            const btnEstado = isActivo
                                ? `<a href="/pedidos/eliminar/${npedido}" class="btn btn-danger btn-sm" title="Dar de baja"
              onclick="return confirm('Â¿Dar de baja?\\n\\nReferencia: ${ref}\\nCliente: ${cliente}\\nNÃºmero: ${npedido}\\n\\nReversible.')">
              <i class="fas fa-ban"></i></a>`
                                : `<a href="/pedidos/reactivar/${npedido}" class="btn btn-success btn-sm" title="Reactivar"
              onclick="return confirm('Â¿Reactivar?\\n\\nReferencia: ${ref}\\nCliente: ${cliente}\\nNÃºmero: ${npedido}')">
              <i class="fas fa-check-circle"></i></a>`;

                            return `
          <div class="dt-actions" style="display:flex; gap:.35rem; flex-wrap:wrap; justify-content:center;">
            <a href="/pedidos/ver/${npedido}" class="btn btn-info btn-sm" title="Ver"><i class="fas fa-eye"></i></a>
            ${btnEditar}
            ${btnEstado}
          </div>
        `;
                        }
                    }
                ];

                // âœ… Si es modo responsive, metemos una columna 0 SOLO control
                const columns = compact
                    ? [{ data: null, title: "", defaultContent: "" }, ...baseColumns]
                    : [...baseColumns];

                // âœ… ColumnDefs SOLO en compact (la columna 0 es el botÃ³n de desplegar)
                const columnDefs = compact ? [{
                    targets: 0,
                    className: "dtr-control",
                    orderable: false,
                    searchable: false,
                    width: "1%"
                }] : [];

                const dt = $("#table").DataTable({
                    ajax: {
                        url: "/api/pedido/listarPedidos",
                        type: "GET",
                        dataSrc: function (json) {
                            return normalizeRows(json); // tu funciÃ³n
                        }
                    },

                    columns,
                    columnDefs,

                    language: { url: "//cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json" },

                    paging: true,
                    searching: true,
                    ordering: !compact,
                    lengthMenu: [5, 10, 15, 25],
                    pageLength: 5,

                    scrollX: true,
                    scrollY: compact ? null : "400px",
                    scrollCollapse: true,
                    fixedHeader: false,
                    autoWidth: false,

                    // âœ… Responsive solo en tablet/mÃ³vil. Desktop = false (todas las columnas)
                    responsive: compact ? { details: { type: "column", target: 0 } } : false,

                    initComplete: function () {
                        if (typeof finalizeTableVisuals === "function") finalizeTableVisuals("#table");
                        this.api().columns.adjust();
                    }
                });

                // cuando termina el ajax
                dt.on("xhr", function () {
                    if (typeof finalizeTableVisuals === "function") finalizeTableVisuals("#table");
                    dt.columns.adjust();
                });

                // cada draw
                dt.on("draw", function () {
                    dt.columns.adjust();
                });
            }

// âœ… Init una vez
            $(function () {
                initPedidosDT(true);
            });

// âœ… Reinit SOLO si cambia de modo (cruza breakpoint)
            let resizeTimer = null;
            window.addEventListener("resize", function () {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => initPedidosDT(false), 150);
            });

            // ========= Eventos (con namespace para no duplicar) =========

            // Toggle filtros (funciona aunque el contenido venga por AJAX)
            $(document)
                .off("click.pedidos", "#toggleBusqueda")
                .on("click.pedidos", "#toggleBusqueda", function (e) {
                    e.preventDefault();

                    const $form = $("#formBusqueda");
                    if (!$form.length) return;

                    // estado inicial si no existe
                    if ($form.data("open") === undefined) {
                        ensureFiltersInitialState();
                    }

                    const abierto = $form.data("open") === true;
                    if (abierto) closeFilters(); else openFilters();

                    // ajusta DT tras animaciÃ³n
                    if ($.fn.DataTable && $.fn.DataTable.isDataTable("#table")) {
                        $("#table").DataTable().columns.adjust();
                    }
                });

            // Submit Buscar (pinta resultados SIEMPRE)
            $(document)
                .off("submit.pedidos", "#formBusqueda")
                .on("submit.pedidos", "#formBusqueda", function (event) {
                    event.preventDefault();

                    const formData = $(this).serialize();

                    $.ajax({
                        type: "POST",
                        url: "/api/pedido/buscar",
                        data: formData,
                        dataType: "json", // âœ… evita texto plano
                        success: function (response) {
                            const rows = normalizeRows(response);

                            if ($.fn.DataTable.isDataTable("#table")) {
                                const dt = $("#table").DataTable();
                                dt.clear();
                                dt.rows.add(rows);
                                dt.draw();
                                dt.columns.adjust();
                            }

                            closeFilters();
                            finalizeTableVisuals("#table");
                        },
                        error: function (xhr, status, error) {
                            console.error("Error en bÃºsqueda:", status, error, xhr.responseText);
                        }
                    });
                });

            // Pieza -> Tipo (delegado)
            $(document)
                .off("change.pedidos", "#pieza")
                .on("change.pedidos", "#pieza", function () {
                    const pieza = this.value;
                    const $tipo = $("#tipo");

                    $.ajax({
                        url: "/api/pedido/tipoPorPieza",
                        method: "GET",
                        dataType: "json"
                    }).done(function (data) {
                        $tipo.empty().append('<option value="" disabled selected>Seleccione un tipo</option>');
                        (data[pieza] || []).forEach(function (t) {
                            $tipo.append(`<option value="${t}">${t}</option>`);
                        });
                    }).fail(function (xhr, s, e) {
                        console.error("Error AJAX tipoPorPieza:", s, e, xhr.responseText);
                    });
                });

            // ========= Arranque =========
            $(function () {
                ensureFiltersInitialState();
                initPedidosDT();
            });

        })();
    </script>
</div>


</html>
