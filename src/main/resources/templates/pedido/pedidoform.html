<script>
    // 游댳 DEBUG: Variable para control de logs
    var DEBUG_MODE = true;
    var DEBUG_LOG = [];

    // Funci칩n de logging para depuraci칩n
    function logDebug(message, data = null) {
        if (DEBUG_MODE) {
            console.log('游댌 DEBUG:', message, data || '');
            DEBUG_LOG.push({
                timestamp: new Date().toISOString(),
                message: message,
                data: data
            });

            // Tambi칠n mostrar en consola m칩vil si es Android
            if (/Android/i.test(navigator.userAgent)) {
                console.log('游님 ANDROID DEBUG:', message, data || '');
            }
        }
    }

    // Funci칩n para mostrar alerta de depuraci칩n
    function showDebugAlert(title, message, data = null) {
        if (DEBUG_MODE) {
            const debugMsg = `${title}\n\n${message}\n\n${data ? JSON.stringify(data, null, 2) : ''}`;
            console.warn('丘멆잺 DEBUG ALERT:', title, data || '');
            alert(debugMsg);
        }
    }

    // Variable global para almacenar los archivos seleccionados
    var archivosPendientes = [];
    var dropZone = null;
    var filesInput = null;

    // Funci칩n para formatear el tama침o del archivo
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Funci칩n para obtener el icono seg칰n el tipo de archivo
    function getFileIcon(fileType) {
        if (fileType.startsWith('image/')) {
            return 'fas fa-file-image';
        } else if (fileType === 'application/pdf') {
            return 'fas fa-file-pdf';
        } else if (fileType.includes('document') || fileType.includes('msword')) {
            return 'fas fa-file-word';
        } else if (fileType.includes('text')) {
            return 'fas fa-file-alt';
        } else {
            return 'fas fa-file';
        }
    }

    // 游댳 MEJORADA: Funci칩n para detectar el origen del archivo
    function detectFileSource(file) {
        try {
            logDebug('detectFileSource - Inicio', {
                nombre: file?.name,
                tama침o: file?.size,
                tipo: file?.type,
                esFile: file instanceof File,
                esBlob: file instanceof Blob
            });

            if (!file) {
                logDebug('detectFileSource - Archivo nulo');
                return 'Desconocido';
            }

            // Para Android: verificar si es archivo de Google Drive
            if (file.name) {
                const nameLower = file.name.toLowerCase();
                const isGoogleDrive = nameLower.includes('drive.google.com') ||
                    nameLower.includes('drive') ||
                    (file.webkitRelativePath && file.webkitRelativePath.includes('Google Drive'));

                if (isGoogleDrive) {
                    logDebug('detectFileSource - Detectado Google Drive por nombre', file.name);
                    return 'Google Drive';
                }
            }

            // Archivos con size 0 o sin type pueden ser de la nube en Android
            if (file.size === 0 || !file.type || file.type === '') {
                logDebug('detectFileSource - Archivo sospechoso (size 0 o sin type)', {
                    size: file.size,
                    type: file.type
                });
                return 'Google Drive (sospechoso)';
            }

            logDebug('detectFileSource - Archivo local normal');
            return 'Local';

        } catch (error) {
            logDebug('detectFileSource - Error', error);
            return 'Error al detectar';
        }
    }

    // 游댳 NUEVA: Funci칩n para procesar archivos de Android/Google Drive
    async function processAndroidFile(file) {
        logDebug('processAndroidFile - Inicio', {
            nombre: file?.name,
            tama침o: file?.size,
            tipo: file?.type
        });

        return new Promise((resolve, reject) => {
            try {
                showDebugAlert('Procesando archivo', `Iniciando procesamiento de: ${file?.name || 'sin nombre'}`);

                // Si el archivo ya es v치lido, usarlo directamente
                if (file.size > 0 && file instanceof File) {
                    logDebug('processAndroidFile - Archivo ya v치lido, no requiere procesamiento');
                    showDebugAlert('Archivo v치lido', `El archivo ${file.name} ya es v치lido`);
                    resolve(file);
                    return;
                }

                logDebug('processAndroidFile - Intentando procesar archivo problem치tico');

                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        logDebug('FileReader onload - Datos le칤dos', {
                            resultadoTipo: typeof e.target.result,
                            tama침oResultado: e.target.result instanceof ArrayBuffer ? e.target.result.byteLength : 'no ArrayBuffer'
                        });

                        showDebugAlert('Archivo le칤do', `Se ley칩 el archivo: ${file.name}`);

                        // Crear un nuevo Blob con los datos
                        const arrayBuffer = e.target.result;
                        const blob = new Blob([arrayBuffer], {
                            type: file.type || 'application/octet-stream'
                        });

                        logDebug('Blob creado', {
                            blobSize: blob.size,
                            blobType: blob.type
                        });

                        // Crear un nuevo File v치lido
                        const processedFile = new File([blob], file.name, {
                            type: blob.type,
                            lastModified: new Date().getTime()
                        });

                        // Copiar propiedades adicionales
                        processedFile.source = file.source + ' (procesado)';

                        logDebug('File creado exitosamente', {
                            nuevoTama침o: processedFile.size,
                            nuevoTipo: processedFile.type,
                            esFile: processedFile instanceof File
                        });

                        showDebugAlert('Archivo procesado', `Archivo ${file.name} procesado exitosamente`);

                        resolve(processedFile);
                    } catch (innerError) {
                        logDebug('Error al procesar archivo en onload', innerError);
                        showDebugAlert('Error en procesamiento', `Error al procesar ${file.name}: ${innerError.message}`);
                        reject(new Error(`Error procesando ${file.name}: ${innerError.message}`));
                    }
                };

                reader.onerror = function(error) {
                    logDebug('FileReader error', {
                        error: error,
                        readyState: reader.readyState,
                        errorCode: reader.error
                    });
                    showDebugAlert('Error de lectura', `No se pudo leer el archivo ${file.name} desde Google Drive`);
                    reject(new Error(`No se pudo leer el archivo desde Google Drive: ${error}`));
                };

                reader.onabort = function() {
                    logDebug('FileReader abortado');
                    showDebugAlert('Lectura abortada', `La lectura del archivo ${file.name} fue abortada`);
                    reject(new Error('Lectura abortada'));
                };

                // Intentar leer el archivo de diferentes maneras
                logDebug('Intentando leer archivo con diferentes m칠todos');

                if (file.arrayBuffer) {
                    logDebug('Usando file.arrayBuffer()');
                    file.arrayBuffer()
                        .then(arrayBuffer => {
                            logDebug('arrayBuffer obtenido', { tama침o: arrayBuffer.byteLength });
                            reader.readAsArrayBuffer(new Blob([arrayBuffer]));
                        })
                        .catch(error => {
                            logDebug('Error en arrayBuffer()', error);
                            showDebugAlert('Error arrayBuffer', `Error con arrayBuffer: ${error.message}`);
                            reader.readAsArrayBuffer(new Blob([]));
                        });
                } else {
                    logDebug('Usando reader.readAsArrayBuffer directamente');
                    reader.readAsArrayBuffer(file);
                }

            } catch (error) {
                logDebug('Error general en processAndroidFile', error);
                showDebugAlert('Error general', `Error procesando archivo: ${error.message}`);
                reject(error);
            }
        });
    }

    // Inicializaci칩n cuando el DOM est치 listo
    document.addEventListener('DOMContentLoaded', function() {
        logDebug('DOMContentLoaded - Inicio');
        showDebugAlert('App iniciada', 'La aplicaci칩n se ha cargado correctamente');

        // Detectar dispositivo y navegador
        const userAgent = navigator.userAgent;
        const isAndroid = /Android/i.test(userAgent);
        const isChrome = /Chrome/i.test(userAgent);

        logDebug('Informaci칩n del navegador', {
            userAgent: userAgent,
            isAndroid: isAndroid,
            isChrome: isChrome,
            platform: navigator.platform
        });

        if (isAndroid) {
            showDebugAlert('Android detectado', `Dispositivo Android detectado\n\nUser Agent: ${userAgent}`);
        }

        // Control de fecha cuando estado es Finalizado
        const estadoSelect = document.querySelector('select[name="estado"]');
        const fechaContainer = document.getElementById('fechaFieldContainer');

        function toggleFechaField() {
            if(estadoSelect.value === 'Finalizado') {
                fechaContainer.style.display = 'block';
            } else {
                fechaContainer.style.display = 'none';
            }
        }

        toggleFechaField();
        estadoSelect.addEventListener('change', toggleFechaField);

        // Inicializar drag and drop
        initializeDragAndDrop();

        // Actualizar contador si hay archivos
        updateFileCounter();

        logDebug('DOMContentLoaded - Finalizado');
    });

    // Funci칩n para inicializar drag and drop
    function initializeDragAndDrop() {
        logDebug('initializeDragAndDrop - Inicio');

        dropZone = document.getElementById('dropZone');
        filesInput = document.getElementById('filesInput');

        if (!dropZone || !filesInput) {
            logDebug('initializeDragAndDrop - Elementos no encontrados', {
                dropZone: !!dropZone,
                filesInput: !!filesInput
            });
            showDebugAlert('Error de inicializaci칩n', 'No se encontraron los elementos para drag and drop');
            return;
        }

        // Click en el 치rea de drop
        dropZone.addEventListener('click', function() {
            logDebug('dropZone click');
            filesInput.click();
        });

        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop zone when dragging over
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('dragover');
        }

        function unhighlight() {
            dropZone.classList.remove('dragover');
        }

        // Handle dropped files
        dropZone.addEventListener('drop', function(e) {
            logDebug('Archivos arrastrados');
            handleDrop(e);
        }, false);

        // Handle selected files from input
        filesInput.addEventListener('change', function(e) {
            logDebug('Archivos seleccionados por input', {
                cantidad: e.target.files?.length || 0
            });
            handleFileSelect(e);
        }, false);

        // 游댳 DEBUG: Mostrar informaci칩n del input file
        logDebug('Input file configurado', {
            accept: filesInput.accept,
            multiple: filesInput.multiple
        });

        // 游댳 NUEVO: A침adir mensaje de advertencia para Android
        if (/Android/i.test(navigator.userAgent)) {
            const warningMsg = document.createElement('div');
            warningMsg.className = 'alert alert-warning mt-3';
            warningMsg.innerHTML = `
                <i class="fas fa-mobile-alt mr-2"></i>
                <strong>MODO DEBUG ACTIVADO</strong><br>
                <small>Dispositivo Android detectado. Si hay problemas con Google Drive, descarga los archivos primero.</small>
            `;
            dropZone.parentNode.insertBefore(warningMsg, dropZone.nextSibling);
        }

        logDebug('initializeDragAndDrop - Finalizado');
    }

    // Manejar archivos arrastrados
    async function handleDrop(e) {
        logDebug('handleDrop - Inicio');
        const dt = e.dataTransfer;
        const files = dt.files;
        logDebug('Archivos en dataTransfer', {
            cantidad: files.length,
            tipos: Array.from(files).map(f => f.type)
        });
        await handleFiles(files);
    }

    // Manejar archivos seleccionados
    async function handleFileSelect(e) {
        logDebug('handleFileSelect - Inicio', {
            cantidadArchivos: e.target.files?.length || 0
        });

        const files = e.target.files;

        if (!files || files.length === 0) {
            logDebug('handleFileSelect - No hay archivos');
            showDebugAlert('Sin archivos', 'No se seleccionaron archivos');
            return;
        }

        // Mostrar informaci칩n de cada archivo
        Array.from(files).forEach((file, i) => {
            logDebug(`Archivo ${i + 1}`, {
                nombre: file.name,
                tama침o: file.size,
                tipo: file.type,
                lastModified: file.lastModified,
                webkitRelativePath: file.webkitRelativePath
            });
        });

        await handleFiles(files);

        // Limpiar input para permitir seleccionar los mismos archivos otra vez
        e.target.value = '';

        logDebug('handleFileSelect - Finalizado');
    }

    // 游댳 MODIFICADA: Procesar archivos con soporte para Android/Google Drive
    async function handleFiles(files) {
        logDebug('handleFiles - Inicio', {
            cantidadTotal: files.length
        });

        const newFiles = Array.from(files);

        // Procesar cada archivo secuencialmente
        for (let i = 0; i < newFiles.length; i++) {
            const file = newFiles[i];

            logDebug(`Procesando archivo ${i + 1}/${newFiles.length}`, {
                nombre: file.name,
                칤ndice: i
            });

            // Verificar si el archivo ya existe
            const alreadyExists = archivosPendientes.some(existingFile =>
                existingFile.name === file.name && existingFile.size === file.size
            );

            if (!alreadyExists) {
                // Detectar origen
                file.source = detectFileSource(file);
                logDebug('Origen detectado', {
                    nombre: file.name,
                    origen: file.source
                });

                try {
                    let finalFile = file;

                    // 游댳 Procesar archivos problem치ticos de Google Drive en Android
                    const isAndroid = /Android/i.test(navigator.userAgent);
                    const isGoogleDrive = file.source.includes('Google');

                    if (isGoogleDrive && (isAndroid || file.size === 0)) {
                        logDebug('Procesando archivo de Google Drive', {
                            nombre: file.name,
                            esAndroid: isAndroid,
                            tama침o: file.size
                        });

                        showDebugAlert('Procesando Google Drive',
                            `Archivo: ${file.name}\nTama침o: ${file.size}\nDispositivo: ${isAndroid ? 'Android' : 'Otro'}`);

                        finalFile = await processAndroidFile(file);
                        finalFile.source = 'Google Drive (procesado)';

                        logDebug('Archivo procesado exitosamente', {
                            nombre: finalFile.name,
                            tama침oOriginal: file.size,
                            tama침oProcesado: finalFile.size
                        });
                    }

                    // Crear URL para vista previa si es imagen
                    if (finalFile.type && finalFile.type.startsWith('image/')) {
                        try {
                            finalFile.previewUrl = URL.createObjectURL(finalFile);
                            logDebug('Vista previa creada', {
                                nombre: finalFile.name,
                                previewUrl: finalFile.previewUrl ? 'Creada' : 'No creada'
                            });
                        } catch (previewError) {
                            logDebug('Error creando vista previa', previewError);
                            showDebugAlert('Error vista previa',
                                `No se pudo crear vista previa para: ${finalFile.name}\nError: ${previewError.message}`);
                        }
                    }

                    archivosPendientes.push(finalFile);
                    logDebug('Archivo a침adido a pendientes', {
                        nombre: finalFile.name,
                        totalPendientes: archivosPendientes.length
                    });

                } catch (error) {
                    logDebug('Error procesando archivo', {
                        nombre: file.name,
                        error: error.message,
                        stack: error.stack
                    });

                    showDebugAlert('Error cr칤tico',
                        `Fallo al procesar: ${file.name}\n\nError: ${error.message}\n\nSe omitir치 este archivo.`);

                    // A침adir archivo original como fallback
                    archivosPendientes.push(file);
                }

                // Actualizar vistas despu칠s de cada archivo
                updateFilePreview();
                updateFilesTable();
                updateFileCounter();
            } else {
                logDebug('Archivo duplicado, omitiendo', {
                    nombre: file.name
                });
            }
        }

        logDebug('handleFiles - Finalizado', {
            archivosProcesados: newFiles.length,
            archivosPendientes: archivosPendientes.length
        });

        if (archivosPendientes.length > 0) {
            showDebugAlert('Procesamiento completado',
                `Se procesaron ${newFiles.length} archivo(s)\nTotal pendientes: ${archivosPendientes.length}`);
        }
    }

    // Actualizar vista previa en grid
    function updateFilePreview() {
        logDebug('updateFilePreview', {
            cantidadArchivos: archivosPendientes.length
        });

        const previewGrid = document.getElementById('filePreviewGrid');
        if (!previewGrid) {
            logDebug('updateFilePreview - Elemento no encontrado');
            return;
        }

        if (archivosPendientes.length === 0) {
            previewGrid.innerHTML = '';
            return;
        }

        let html = '';
        archivosPendientes.forEach((file, index) => {
            const fileIcon = getFileIcon(file.type);
            const fileSize = formatFileSize(file.size);

            html += `
                <div class="file-preview-card">
                    <span class="file-info-badge">${file.source || 'Archivo'}</span>
                    <div class="file-icon">
                        <i class="${fileIcon}"></i>
                    </div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                    <button class="file-remove" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        });

        previewGrid.innerHTML = html;
        logDebug('updateFilePreview - HTML actualizado');
    }

    // Actualizar tabla de archivos
    function updateFilesTable() {
        logDebug('updateFilesTable');

        const tableBody = document.getElementById('filesTableBody');
        const tableContainer = document.getElementById('filesTableContainer');

        if (!tableBody || !tableContainer) {
            logDebug('updateFilesTable - Elementos no encontrados');
            return;
        }

        if (archivosPendientes.length === 0) {
            tableContainer.style.display = 'none';
            tableBody.innerHTML = '';
            return;
        }

        tableContainer.style.display = 'block';

        let html = '';
        archivosPendientes.forEach((file, index) => {
            const fileIcon = getFileIcon(file.type);
            const fileSize = formatFileSize(file.size);
            const sourceBadge = (file.source && file.source.includes('Google')) ? 'badge-cloud' : 'badge-local';

            let previewHtml = 'No disponible';
            if (file.type && file.type.startsWith('image/') && file.previewUrl) {
                previewHtml = `<img src="${file.previewUrl}" class="file-preview-img" alt="Vista previa">`;
            }

            html += `
                <tr>
                    <td>
                        <i class="${fileIcon} mr-2"></i>
                        ${file.name}
                    </td>
                    <td>${file.type || 'Desconocido'}</td>
                    <td>${fileSize}</td>
                    <td>
                        <span class="file-source-badge ${sourceBadge}">
                            ${file.source || 'Local'}
                        </span>
                    </td>
                    <td>${previewHtml}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeFile(${index})">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </td>
                </tr>
            `;
        });

        tableBody.innerHTML = html;
        logDebug('updateFilesTable - Tabla actualizada', {
            filas: archivosPendientes.length
        });
    }

    // Eliminar un archivo
    function removeFile(index) {
        logDebug('removeFile', { 칤ndice: index });

        if (archivosPendientes[index]) {
            logDebug('Archivo a eliminar', {
                nombre: archivosPendientes[index].name
            });

            if (archivosPendientes[index].previewUrl) {
                URL.revokeObjectURL(archivosPendientes[index].previewUrl);
                logDebug('URL de vista previa revocada');
            }
        }

        archivosPendientes.splice(index, 1);
        updateFilePreview();
        updateFilesTable();
        updateFileCounter();

        logDebug('Archivo eliminado', {
            archivosRestantes: archivosPendientes.length
        });
    }

    // Actualizar contador de archivos
    function updateFileCounter() {
        logDebug('updateFileCounter', {
            archivosPendientes: archivosPendientes.length
        });

        const counter = document.getElementById('fileCounter');
        const countElement = document.getElementById('fileCount');

        if (counter && countElement) {
            if (archivosPendientes.length > 0) {
                counter.style.display = 'inline-flex';
                countElement.textContent = archivosPendientes.length;
                logDebug('Contador actualizado', { valor: archivosPendientes.length });
            } else {
                counter.style.display = 'none';
                logDebug('Contador ocultado');
            }
        } else {
            logDebug('updateFileCounter - Elementos no encontrados');
        }
    }

    // Guardar archivos y cerrar modal
    function saveFiles() {
        logDebug('saveFiles - Guardando archivos', {
            cantidad: archivosPendientes.length
        });

        showDebugAlert('Guardando archivos',
            `Se guardar치n ${archivosPendientes.length} archivo(s) en la lista de pendientes`);

        $('#addPhotoModal').modal('hide');
        updateFileCounter();

        // Mostrar mensaje de 칠xito
        if (archivosPendientes.length > 0) {
            showToast('success', `${archivosPendientes.length} archivo(s) listo(s) para guardar.`);
        }
    }

    // Mostrar toast de notificaci칩n
    function showToast(type, message) {
        logDebug('showToast', { tipo: type, mensaje: message });
        alert(message);
    }

    ClassicEditor
        .create(document.querySelector('#observacion'))
        .catch(error => {
            logDebug('Error CKEditor', error);
        });

    // 游댳 NUEVO: Funci칩n para exportar logs de depuraci칩n
    function exportDebugLogs() {
        const logText = DEBUG_LOG.map(entry =>
            `[${entry.timestamp}] ${entry.message} ${entry.data ? JSON.stringify(entry.data) : ''}`
        ).join('\n');

        const blob = new Blob([logText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `debug_log_${new Date().toISOString().slice(0,19)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        logDebug('Logs exportados', { entradas: DEBUG_LOG.length });
        showDebugAlert('Logs exportados', `Se exportaron ${DEBUG_LOG.length} entradas de depuraci칩n`);
    }

    // 游댳 NUEVO: Bot칩n para exportar logs (para depuraci칩n en producci칩n)
    document.addEventListener('DOMContentLoaded', function() {
        // Crear bot칩n de debug flotante
        const debugBtn = document.createElement('button');
        debugBtn.id = 'debugBtn';
        debugBtn.innerHTML = '游냍 DEBUG';
        debugBtn.style.position = 'fixed';
        debugBtn.style.bottom = '20px';
        debugBtn.style.right = '20px';
        debugBtn.style.zIndex = '99999';
        debugBtn.style.background = '#dc3545';
        debugBtn.style.color = 'white';
        debugBtn.style.border = 'none';
        debugBtn.style.borderRadius = '50%';
        debugBtn.style.width = '50px';
        debugBtn.style.height = '50px';
        debugBtn.style.fontSize = '10px';
        debugBtn.style.cursor = 'pointer';
        debugBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        debugBtn.title = 'Exportar logs de depuraci칩n';

        debugBtn.onclick = function() {
            exportDebugLogs();
        };

        document.body.appendChild(debugBtn);
    });
</script>
<script th:inline="javascript">
    // 游댳 DEBUG: Log adicional para Thymeleaf
    console.log('游댌 THYMELEAF DEBUG - tiposPorPieza:', tiposPorPieza);

    // Funci칩n para actualizar los tipos de pieza (se conserva)
    function actualizarTipos() {
        logDebug('actualizarTipos - Inicio');

        var pieza = document.getElementById('pieza').value;
        var contTipo = document.getElementById('container-tipo');
        var selectTipo = document.getElementById('tipo');
        var lista = tiposPorPieza[pieza] || [];

        logDebug('actualizarTipos - Datos', {
            piezaSeleccionada: pieza,
            tiposDisponibles: lista,
            cantidadTipos: lista.length
        });

        // Si la pieza no tiene m칰ltiples tipos, ocultamos todo el contenedor
        if (lista.length <= 1 && ['Pulsera','Broche','Otros'].indexOf(pieza) !== -1) {
            contTipo.style.display = 'none';
            logDebug('actualizarTipos - Contenedor ocultado');
            return;
        } else {
            contTipo.style.display = 'block';
            logDebug('actualizarTipos - Contenedor mostrado');
        }

        // Limpiar opciones
        selectTipo.innerHTML = '<option value="">-- Selecciona Tipo --</option>';

        // Rellenar con los nuevos
        lista.forEach(function(t) {
            var opt = document.createElement('option');
            opt.value = t;
            opt.text  = t;
            selectTipo.add(opt);
        });

        logDebug('actualizarTipos - Finalizado', {
            opcionesAgregadas: lista.length
        });
    }

    // Al cargar la p치gina, forzar llenado si ya hay valor en pedido.pieza (se conserva)
    document.addEventListener('DOMContentLoaded', function() {
        logDebug('Thymeleaf DOMContentLoaded - Inicio');

        if (document.getElementById('pieza').value) {
            actualizarTipos();
            // Y si ya existe pedido.tipo, seleccionarlo:
            var tipoActual = /*[[${pedido.tipo}]]*/ '';
            if (tipoActual) {
                document.getElementById('tipo').value = tipoActual;
                logDebug('Tipo preseleccionado', { tipo: tipoActual });
            }
        }

        logDebug('Thymeleaf DOMContentLoaded - Finalizado');
    });

    // 游댳 MODIFICADA: Manejar el env칤o del formulario principal (#pedidoForm)
    $(document).on('submit', '#pedidoForm', async function(event) {
        event.preventDefault();

        logDebug('Env칤o formulario - Inicio');
        showDebugAlert('Iniciando env칤o', 'Comenzando el proceso de guardado del pedido...');

        // Mostrar spinner antes de cualquier env칤o
        $("#spinnerGuardado").show();

        try {
            // 游댳 DEBUG: Registrar informaci칩n del formulario
            const formData = new FormData(this);
            const formEntries = {};
            for (let [key, value] of formData.entries()) {
                if (key !== 'files') {
                    formEntries[key] = value;
                }
            }

            logDebug('Datos del formulario', formEntries);

            // Procesar archivos problem치ticos antes de enviar
            const processedFiles = [];

            logDebug('Procesando archivos para env칤o', {
                totalArchivos: archivosPendientes.length
            });

            for (let i = 0; i < archivosPendientes.length; i++) {
                const file = archivosPendientes[i];

                logDebug(`Procesando archivo ${i + 1}/${archivosPendientes.length} para env칤o`, {
                    nombre: file.name,
                    tama침o: file.size,
                    tipo: file.type,
                    origen: file.source
                });

                // Solo procesar si es de Google Drive y parece problem치tico
                if (file.source && file.source.includes('Google') &&
                    (file.size === 0 || !file.type || file.type === '')) {

                    try {
                        showDebugAlert('Procesando archivo para env칤o',
                            `Convirtiendo archivo de Google Drive: ${file.name}`);

                        const processed = await processAndroidFile(file);
                        processedFiles.push(processed);

                        logDebug('Archivo procesado exitosamente para env칤o', {
                            nombre: processed.name,
                            tama침oOriginal: file.size,
                            tama침oProcesado: processed.size
                        });

                    } catch (processError) {
                        logDebug('Error procesando archivo para env칤o', {
                            nombre: file.name,
                            error: processError.message
                        });

                        showDebugAlert('Error en archivo',
                            `No se pudo procesar ${file.name}. Se intentar치 con el original.\nError: ${processError.message}`);

                        // Usar archivo original como fallback
                        processedFiles.push(file);
                    }
                } else {
                    processedFiles.push(file);
                }
            }

            // 游댳 VALIDACI칍N FINAL: Verificar que los archivos sean v치lidos
            const validFiles = processedFiles.filter(file => {
                const isValid = file && file.name && (file instanceof File || file instanceof Blob);

                if (!isValid) {
                    logDebug('Archivo inv치lido detectado', {
                        archivo: file,
                        esFile: file instanceof File,
                        esBlob: file instanceof Blob
                    });
                }

                return isValid;
            });

            logDebug('Validaci칩n de archivos', {
                total: processedFiles.length,
                v치lidos: validFiles.length,
                inv치lidos: processedFiles.length - validFiles.length
            });

            showDebugAlert('Archivos validados',
                `Total: ${processedFiles.length}\nV치lidos: ${validFiles.length}\nInv치lidos: ${processedFiles.length - validFiles.length}`);

            if (validFiles.length !== processedFiles.length) {
                logDebug('Algunos archivos son inv치lidos', {
                    archivosInv치lidos: processedFiles.filter(f => !(f && f.name && (f instanceof File || f instanceof Blob)))
                });
            }

            // 2. Crear un objeto FormData a partir del formulario
            var formData = new FormData(this);

            // 3. A침adir archivos procesados
            validFiles.forEach(function(file) {
                formData.append('files', file);
                logDebug('Archivo a침adido al FormData', { nombre: file.name });
            });

            logDebug('FormData preparado para env칤o', {
                totalArchivosEnFormData: validFiles.length,
                tama침oEstimado: validFiles.reduce((sum, f) => sum + (f.size || 0), 0)
            });

            // 4. Enviar SIEMPRE el formulario v칤a AJAX
            $.ajax({
                type: 'POST',
                url: $(this).attr('action'),
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                timeout: 30000, // 游댳 Aumentar timeout para archivos grandes
                xhr: function() {
                    var xhr = new window.XMLHttpRequest();
                    // Upload progress
                    xhr.upload.addEventListener("progress", function(evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total * 100;
                            logDebug('Progreso de upload', {
                                porcentaje: percentComplete.toFixed(2),
                                loaded: evt.loaded,
                                total: evt.total
                            });
                            console.log('游닋 Upload:', percentComplete.toFixed(2) + '%');
                        }
                    }, false);
                    return xhr;
                },
                beforeSend: function() {
                    logDebug('AJAX beforeSend - Enviando petici칩n');
                    showDebugAlert('Enviando datos', 'Iniciando env칤o al servidor...');
                },
                success: function(response) {
                    logDebug('AJAX success - Respuesta recibida', response);
                    showDebugAlert('Respuesta del servidor', 'El servidor respondi칩 correctamente');

                    if (response && response.info) {
                        logDebug('Informaci칩n adicional', response.info);
                    }

                    if (response && response.redirectUrl) {
                        // Limpiar archivos despu칠s de guardar exitosamente
                        archivosPendientes.forEach(file => {
                            if (file.previewUrl) {
                                URL.revokeObjectURL(file.previewUrl);
                            }
                        });
                        archivosPendientes = [];
                        updateFileCounter();

                        logDebug('Redireccionando', { url: response.redirectUrl });
                        showDebugAlert('Redireccionando', `Guardado exitoso. Redirigiendo a: ${response.redirectUrl}`);

                        // 游댠 Cargar solo el contenido nuevo, sin recargar toda la p치gina
                        $.get(response.redirectUrl, function(html) {
                            var nuevoContenido = $(html).find('#pedidoContent').html();
                            $('#pedidoContent').html(nuevoContenido);

                            // Actualizar URL del navegador sin recargar
                            history.pushState(null, "", response.redirectUrl);

                            // Ocultar spinner al terminar
                            $("#spinnerGuardado").hide();

                            logDebug('Redirecci칩n completada');
                            showDebugAlert('Operaci칩n completada', 'El pedido se guard칩 exitosamente');
                        });
                    } else {
                        $("#spinnerGuardado").hide();
                        logDebug('Respuesta sin redirectUrl', response);
                        showDebugAlert('Advertencia', 'Pedido guardado, pero no se recibi칩 URL de redirecci칩n.');
                    }
                },
                error: function(xhr, status, error) {
                    logDebug('AJAX error', {
                        status: status,
                        error: error,
                        xhrStatus: xhr.status,
                        xhrStatusText: xhr.statusText,
                        responseText: xhr.responseText
                    });

                    // 游댳 MEJOR MANEJO DE ERRORES PARA ANDROID
                    let errorMessage = "Ocurri칩 un error al guardar el pedido.";

                    if (status === "timeout") {
                        errorMessage = "El tiempo de espera se agot칩 (30 segundos). Los archivos pueden ser muy grandes o hay problemas de conexi칩n.";
                    } else if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 413) {
                        errorMessage = "Los archivos son demasiado grandes. El servidor rechaz칩 la petici칩n.";
                    } else if (xhr.status === 415) {
                        errorMessage = "Tipo de archivo no soportado.";
                    } else if (xhr.status === 500) {
                        errorMessage = "Error interno del servidor.";
                    } else if (/Android/i.test(navigator.userAgent)) {
                        errorMessage = "Error en Android. Si est치s usando archivos de Google Drive, intenta:\n1. Descargarlos primero a tu dispositivo\n2. Reducir el tama침o de los archivos\n3. Intentar con menos archivos";
                    }

                    showDebugAlert('Error de env칤o',
                        `Status: ${status}\nError: ${error}\n\n${errorMessage}\n\nC칩digo HTTP: ${xhr.status}\nRespuesta: ${xhr.responseText?.substring(0, 200) || 'Sin respuesta'}`);

                    $("#spinnerGuardado").hide();

                    // 游댳 OFRECER SOLUCI칍N ALTERNATIVA
                    if (confirm(`ERROR: ${errorMessage}\n\n쯈uieres intentar guardar sin los archivos adjuntos?`)) {
                        // Eliminar archivos y reintentar
                        logDebug('Reintentando sin archivos');
                        archivosPendientes = [];
                        updateFileCounter();
                        $(event.target).submit();
                    }
                },
                complete: function() {
                    logDebug('AJAX complete - Petici칩n finalizada');
                }
            });

        } catch (error) {
            logDebug('Error general preparando archivos', {
                error: error.message,
                stack: error.stack
            });

            showDebugAlert('Error cr칤tico en cliente',
                `Error procesando archivos:\n\n${error.message}\n\nStack: ${error.stack}`);

            $("#spinnerGuardado").hide();

            if (/Android/i.test(navigator.userAgent)) {
                alert("游뚿 PROBLEMA EN ANDROID DETECTADO 游뚿\n\n" +
                    "Error: " + error.message + "\n\n" +
                    "Soluci칩n sugerida:\n" +
                    "1. Descarga los archivos de Google Drive a tu dispositivo\n" +
                    "2. Usa archivos m치s peque침os\n" +
                    "3. Intenta con menos archivos a la vez\n" +
                    "4. Reinicia la aplicaci칩n\n\n" +
                    "Informaci칩n para soporte:\n" +
                    "User Agent: " + navigator.userAgent);
            } else {
                alert("Error procesando archivos: " + error.message);
            }
        }
    });
</script>