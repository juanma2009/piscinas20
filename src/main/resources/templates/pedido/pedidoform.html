<!-- ...código HTML anterior... -->
<script>
// Declarar archivos pendientes como variables globales
window.archivosPendientes = window.archivosPendientes || [];
window.googleDriveFiles = window.googleDriveFiles || [];

/**
 * Añade logs y comentarios al flujo de subida de archivos adjuntos para robustecer su gestión y evitar recargas o limpieza prematura.
 */

function agregarArchivoLocal(archivo) {
    // Agregar archivo local a la lista global
    window.archivosPendientes.push(archivo);
    console.log('[Adjuntos] Archivo agregado a archivosPendientes:', archivo);
}

function agregarArchivoGoogleDrive(archivo) {
    // Agregar archivo Google Drive a la lista global
    window.googleDriveFiles.push(archivo);
    console.log('[Adjuntos] Archivo Drive agregado a googleDriveFiles:', archivo);
}

function subirArchivosAdjuntos(pedidoId, callback) {
    // Enviar archivos locales y Drive mediante AJAX (PASO 1)
    console.log('[Adjuntos] Iniciando subida AJAX de archivos adjuntos. archivosPendientes.length:', window.archivosPendientes.length, 'googleDriveFiles.length:', window.googleDriveFiles.length);

    var formData = new FormData();
    window.archivosPendientes.forEach(function(f, idx) {
        formData.append('archivos['+idx+']', f);
    });
    window.googleDriveFiles.forEach(function(gf, idx) {
        formData.append('googleDriveIds['+idx+']', gf.id);
    });
    formData.append('pedidoId', pedidoId);

    $.ajax({
        url: '/pedido/adjuntos',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        beforeSend: function() {
            console.log('[Adjuntos] AJAX subida de adjuntos: antes de enviar');
        },
        success: function(resp) {
            console.log('[Adjuntos] AJAX subida de adjuntos: éxito', resp);
            // Sólo limpiar arrays globales tras éxito de la subida
            window.archivosPendientes = [];
            window.googleDriveFiles = [];
            if (typeof callback === 'function') callback(resp);
        },
        error: function(err) {
            console.error('[Adjuntos] AJAX subida de adjuntos: error', err);
            // No limpiar arrays en caso de fallo
        }
    });
}

function crearPedido(datosFormulario) {
    // Paso 1: crear pedido vía AJAX
    console.log('[Pedido] Iniciando creación AJAX de pedido');
    $.ajax({
        url: '/pedido/crear',
        method: 'POST',
        data: datosFormulario,
        beforeSend: function() {
            console.log('[Pedido] AJAX creación de pedido: antes de enviar');
        },
        success: function(resp) {
            console.log('[Pedido] AJAX creación de pedido: éxito', resp);
            if(resp.pedidoId) {
                // PASO 2: subir adjuntos usando las variables globales
                subirArchivosAdjuntos(resp.pedidoId, function(respAdjuntos) {
                    console.log('[Flujo] Adjuntos subidos correctamente. Fin del flujo.');
                    // NO hacer recarga aquí; el flujo puede continuar según lógica UI
                });
            }
        },
        error: function(err) {
            console.error('[Pedido] AJAX creación de pedido: error', err);
            // No limpiar archivosPendientes/Drive aquí
        }
    });
}

// Comentarios en cada paso aseguran correcta gestión del estado global

// ...Resto del código JS, enlace de botones, handlers de input, etc...código HTML posterior...
</script>
<!-- ... -->
