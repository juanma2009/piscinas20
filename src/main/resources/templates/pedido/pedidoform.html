<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="admin/admin_layout">
<head>
    <!-- Agregar jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script th:inline="javascript">
        /*<![CDATA[*/
        var tiposPorPieza = /*[[${tiposPorPieza}]]*/ {};
        /*]]>*/
    </script>

    <style>
        /* [Mantener todos los estilos CSS igual] */
    </style>
</head>

<body>
<div id="pedidoContent" layout:fragment="content">

    <div id="messege"></div>

    <section class="content-header">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div th:text="${titulo}"></div>
            </div>

            <!-- Botones de navegación -->
            <div class="row justify-content-between align-items-center">
                <div class="col-md-8">
                    <div class="btn-group btn-group-toggle">
                        <a th:href="@{/pedidos/listarPedidos}" class="btn btn-outline-primary">
                            <i class="fas fa-list"></i> <span>Pedidos</span>
                        </a>
                        <a th:href="@{/pedidos/listarFotosPedidos}" class="btn btn-outline-primary">
                            <i class="fas fa-images"></i> <span>Galería</span>
                        </a>
                        <a th:href="@{/listar}" class="btn btn-outline-primary">
                            <i class="fas fa-user"></i> <span>Clientes</span>
                        </a>
                        <a th:href="@{/form}" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus"></i> <span>Nuevo Cliente</span>
                        </a>
                    </div>
                </div>
            </div>
            <div></div>
            <div class="container-fluid mt-3">
                <form id="pedidoForm" th:action="@{/pedidos/form/}" enctype="multipart/form-data" th:object="${pedido}"
                      method="post">
                    <!-- Campo oculto para npedido -->
                    <input type="hidden" th:if="${pedido.npedido != null}" th:field="*{npedido}" id="npedidoHidden" />

                    <!-- Navegación de pestañas -->
                    <ul class="nav nav-tabs" id="pedidoTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="detalles-tab" data-toggle="tab" href="#detalles" role="tab"
                               aria-controls="detalles" aria-selected="true">
                                Informacion General
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="detalles-adicionales-tab" data-toggle="tab" href="#detalles-adicionales"
                               role="tab" aria-controls="detalles-adicionales" aria-selected="false">
                                Detalles
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="comentario-tab" data-toggle="tab" href="#comentario" role="tab"
                               aria-controls="comentario" aria-selected="false">
                                Comentario
                            </a>
                        </li>
                    </ul>
                    <div></div>

                    <!-- Contenido de las pestañas -->
                    <div class="tab-content" id="pedidoTabContent">
                        <!-- Pestaña Información General -->
                        <div class="tab-pane fade show active" id="detalles" role="tabpanel" aria-labelledby="detalles-tab">
                            <!-- Nueva fila: Cliente, Nº Pedido y Estado -->
                            <div class="row">
                                <!-- Cliente -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="cliente">Cliente</label>
                                        <input name="cliente"
                                               th:value="${pedido.cliente.nombre} + ' ' + ${pedido.cliente.apellido}"
                                               class="form-control" disabled/>
                                        <!-- Campo oculto para el ID del cliente -->
                                        <input type="hidden" name="clienteId" th:value="${pedido.cliente.id}" />
                                    </div>
                                </div>

                                <!-- Nº Pedido -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="npedido">Nº Pedido</label>
                                        <input type="text" th:if="${pedido.npedido != null}"
                                               th:value="${pedido.npedido}"
                                               class="form-control"
                                               readonly
                                               disabled />
                                        <input type="text" th:unless="${pedido.npedido != null}"
                                               th:value="${numeroPedido}"
                                               class="form-control"
                                               readonly
                                               disabled />
                                        <!-- Campo oculto para enviar el npedido -->
                                        <input type="hidden" th:if="${pedido.npedido != null}"
                                               name="npedido"
                                               th:value="${pedido.npedido}" />
                                        <input type="hidden" th:unless="${pedido.npedido != null}"
                                               name="npedido"
                                               th:value="${numeroPedido}" />
                                    </div>
                                </div>

                                <!-- Empleado -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="empleado">Empleado</label>
                                        <select name="empleado" class="form-control" th:field="*{empleado}">
                                            <option th:each="empleado : ${empleado}" th:value="${empleado}" th:text="${empleado}"></option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Resto de campos en Información General -->
                            <div class="row">
                                <!-- Estado -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="estado">Estado</label>
                                        <select name="estado" class="form-control" th:field="*{estado}">
                                            <option th:each="estado : ${estados}" th:value="${empleado}" th:text="${estado}"></option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Fecha -->
                                <div class="col-md-4" id="">
                                    <div class="form-group">
                                        <label for="fechaEntrega">Fecha Entregado</label>
                                        <input type="date" name="fechaEntrega" class="form-control" th:field="*{fechaEntrega}" />
                                    </div>
                                </div>

                                <div class="col-md-4" id="fechaFieldContainer">
                                    <div class="form-group">
                                        <label for="fechaFinalizado">Fecha Finalizado</label>
                                        <input type="date" name="fechaFinalizado" class="form-control" th:field="*{fechaFinalizado}" />
                                    </div>
                                </div>

                                <!-- Referencia -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="ref">Referencia</label>
                                        <input name="ref" th:value="${pedido.ref}" class="form-control" />
                                    </div>
                                </div>

                                <!-- Servicio -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="tipoPedido">Servicio</label>
                                        <select id="tipoPedido" name="tipoPedido" class="form-control" th:field="*{tipoPedido}">
                                            <option th:each="s : ${servicios}"
                                                    th:value="${s}"
                                                    th:text="${s}"
                                                    th:selected="${pedido.tipoPedido == s}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Botón para añadir fotos -->
                            <div class="form-group text-center mt-3">
                                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#addPhotoModal">
                                    <i class="fas fa-camera"></i> Añadir Fotos
                                </button>
                                <span id="fileCounter" class="file-counter" style="display: none;">
                                    <i class="fas fa-file mr-1"></i>
                                    <span id="fileCount">0</span> archivos
                                </span>
                            </div>
                        </div>

                        <!-- Pestaña Detalles Adicionales -->
                        <div class="tab-pane fade" id="detalles-adicionales" role="tabpanel" aria-labelledby="detalles-adicionales-tab">
                            <div class="row">
                                <!-- Metal -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="grupo">Metal</label>
                                        <select id="grupo" name="grupo" class="form-control" th:field="*{grupo}">
                                            <option th:each="m : ${metales}"
                                                    th:value="${m}"
                                                    th:text="${m}">
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Pieza -->
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="pieza">Pieza</label>
                                        <select id="pieza" name="pieza" class="form-control" th:field="*{pieza}"
                                                onchange="actualizarTipos()">
                                            <option value="">-- Selecciona Pieza --</option>
                                            <option th:each="p : ${piezas}"
                                                    th:value="${p}"
                                                    th:text="${p}"
                                                    th:selected="${pedido.pieza == p}">
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Tipo (dinámico) -->
                                <div class="col-md-4" id="container-tipo">
                                    <div class="form-group">
                                        <label for="tipo">Tipo</label>
                                        <select id="tipo" name="tipo" class="form-control" th:field="*{tipo}">
                                            <option value="">-- Primero elige Pieza --</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <!-- Peso -->
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="peso">Peso</label>
                                        <input name="peso" th:value="${pedido.peso}" class="form-control"/>
                                    </div>
                                </div>

                                <!-- Horas -->
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="horas">Horas</label>
                                        <input name="horas" th:value="${pedido.horas}" class="form-control"/>
                                    </div>
                                </div>

                                <!-- Cobrado -->
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="cobrado">Cobrado</label>
                                        <input name="cobrado" th:value="${pedido.cobrado}" class="form-control"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pestaña Comentario -->
                        <div class="tab-pane fade" id="comentario" role="tabpanel" aria-labelledby="comentario-tab">
                            <div class="form-group">
                                <label for="observacion">Observaciones</label>
                                <textarea id="observacion" name="observacion" class="form-control" th:text="${pedido.observacion}"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Campos ocultos adicionales -->
                    <input type="hidden" name="isEditMode" id="isEditMode" th:value="${pedido.npedido != null ? 'true' : 'false'}" />

                    <!-- Botones del formulario -->
                    <div class="form-group">
                        <input type="submit" th:value="${titulo}" class="btn btn-primary" id="submitBtn" />
                        <button type="reset" class="btn btn-secondary">Resetear</button>
                    </div>
                </form>
            </div>
            <div id="spinnerGuardado" class="overlay" style="display:none; z-index: 9999;">
                <i class="fa fa-refresh fa-spin"></i>
            </div>
        </div>

        <!-- Modal for file upload -->
        <div class="modal fade" id="addPhotoModal" tabindex="-1" role="dialog" aria-labelledby="addPhotoModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addPhotoModalLabel">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                            Añadir Archivos
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Área de arrastrar y soltar -->
                        <div class="file-upload-area" id="dropZone">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">
                                Arrastra y suelta tus archivos aquí
                            </div>
                            <div class="upload-subtext">
                                O haz clic para seleccionar archivos
                            </div>
                            <div class="upload-subtext">
                                <small>Puedes seleccionar desde tu dispositivo, Google Drive, Dropbox, etc.</small>
                            </div>
                            <div class="upload-subtext">
                                <small>Formatos aceptados: imágenes (JPG, PNG, GIF), PDF, documentos (DOC, DOCX)</small>
                            </div>
                        </div>

                        <!-- Input de archivo oculto -->
                        <input type="file"
                               id="filesInput"
                               name="files"
                               multiple
                               style="display: none;"
                               accept="image/*,.pdf,.doc,.docx,.txt">

                        <!-- Vista previa en grid -->
                        <div id="filePreviewGrid" class="file-preview-grid"></div>

                        <!-- Tabla de archivos -->
                        <div class="table-responsive mt-4" id="filesTableContainer" style="display: none;">
                            <table class="files-table">
                                <thead>
                                <tr>
                                    <th>Archivo</th>
                                    <th>Tipo</th>
                                    <th>Tamaño</th>
                                    <th>Origen</th>
                                    <th>Vista Previa</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="filesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times mr-2"></i> Cancelar
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveFiles()">
                            <i class="fas fa-save mr-2"></i> Guardar Archivos
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.ckeditor.com/ckeditor5/35.0.1/classic/ckeditor.js"></script>
        <script>
            // Variable global para almacenar los archivos seleccionados
            var archivosPendientes = [];
            var dropZone = null;
            var filesInput = null;
            var isProcessingDriveFiles = false;

            // Función para detectar si un archivo viene de Google Drive
            function esArchivoGoogleDrive(file) {
                return file.name && (
                    file.name.includes('drive.google.com') ||
                    file.name.toLowerCase().includes('drive') ||
                    (file.webkitRelativePath && file.webkitRelativePath.includes('Google Drive')) ||
                    file.size === 0 || // Archivos de Drive a veces tienen size=0
                    file.type === '' // Archivos de Drive a veces no tienen type
                );
            }

            // Función para descargar archivos de Google Drive
            function descargarArchivoGoogleDrive(file) {
                return new Promise((resolve, reject) => {
                    // Si el archivo ya tiene datos (no es de Drive), devolverlo directamente
                    if (file.size > 0 && file.type !== '' && !esArchivoGoogleDrive(file)) {
                        resolve(file);
                        return;
                    }

                    // Para archivos de Google Drive, necesitamos crear un nuevo File con los datos reales
                    // Esto es una simplificación - en realidad necesitarías la API de Google Drive
                    // Por ahora, intentamos leer el archivo como ArrayBuffer
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        try {
                            // Crear un nuevo File con los datos reales
                            const blob = new Blob([e.target.result], { type: file.type || 'application/octet-stream' });
                            const newFile = new File([blob], file.name, {
                                type: file.type || 'application/octet-stream',
                                lastModified: file.lastModified || Date.now()
                            });
                            resolve(newFile);
                        } catch (error) {
                            console.warn('Error al procesar archivo de Drive:', error);
                            // Si falla, devolver el archivo original
                            resolve(file);
                        }
                    };

                    reader.onerror = function() {
                        console.warn('Error al leer archivo de Drive:', file.name);
                        // Si falla la lectura, devolver el archivo original
                        resolve(file);
                    };

                    // Intentar leer el archivo
                    reader.readAsArrayBuffer(file);
                });
            }

            // Función para procesar todos los archivos (especialmente los de Google Drive)
            async function procesarArchivosParaEnvio() {
                const archivosProcesados = [];

                for (const file of archivosPendientes) {
                    if (esArchivoGoogleDrive(file)) {
                        try {
                            console.log('Procesando archivo de Google Drive:', file.name);
                            const processedFile = await descargarArchivoGoogleDrive(file);
                            archivosProcesados.push(processedFile);
                        } catch (error) {
                            console.error('Error al procesar archivo de Drive:', file.name, error);
                            // Si falla, añadir el archivo original
                            archivosProcesados.push(file);
                        }
                    } else {
                        archivosProcesados.push(file);
                    }
                }

                return archivosProcesados;
            }

            // Inicialización cuando el DOM está listo
            document.addEventListener('DOMContentLoaded', function() {
                // Control de fecha cuando estado es Finalizado
                const estadoSelect = document.querySelector('select[name="estado"]');
                const fechaContainer = document.getElementById('fechaFieldContainer');

                function toggleFechaField() {
                    if(estadoSelect.value === 'Finalizado') {
                        fechaContainer.style.display = 'block';
                    } else {
                        fechaContainer.style.display = 'none';
                    }
                }

                toggleFechaField();
                estadoSelect.addEventListener('change', toggleFechaField);

                // Inicializar drag and drop
                initializeDragAndDrop();

                // Actualizar contador si hay archivos
                updateFileCounter();
            });

            // Función para inicializar drag and drop
            function initializeDragAndDrop() {
                dropZone = document.getElementById('dropZone');
                filesInput = document.getElementById('filesInput');

                if (!dropZone || !filesInput) return;

                dropZone.addEventListener('click', function() {
                    filesInput.click();
                });

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });

                function highlight() {
                    dropZone.classList.add('dragover');
                }

                function unhighlight() {
                    dropZone.classList.remove('dragover');
                }

                dropZone.addEventListener('drop', handleDrop, false);
                filesInput.addEventListener('change', handleFileSelect, false);
            }

            // Manejar archivos arrastrados
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            // Manejar archivos seleccionados
            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
                e.target.value = '';
            }

            // Procesar archivos
            function handleFiles(files) {
                const newFiles = Array.from(files);

                newFiles.forEach(file => {
                    const alreadyExists = archivosPendientes.some(existingFile =>
                        existingFile.name === file.name && existingFile.size === file.size
                    );

                    if (!alreadyExists) {
                        // Detectar origen
                        file.source = esArchivoGoogleDrive(file) ? 'Google Drive' : 'Local';

                        // Crear URL para vista previa si es imagen
                        if (file.type.startsWith('image/')) {
                            file.previewUrl = URL.createObjectURL(file);
                        }

                        archivosPendientes.push(file);
                    }
                });

                updateFilePreview();
                updateFilesTable();
                updateFileCounter();
            }

            // Actualizar vista previa en grid
            function updateFilePreview() {
                const previewGrid = document.getElementById('filePreviewGrid');
                if (!previewGrid) return;

                if (archivosPendientes.length === 0) {
                    previewGrid.innerHTML = '';
                    return;
                }

                let html = '';
                archivosPendientes.forEach((file, index) => {
                    const fileIcon = getFileIcon(file.type);
                    const fileSize = formatFileSize(file.size);

                    html += `
                        <div class="file-preview-card">
                            <span class="file-info-badge">${file.source}</span>
                            <div class="file-icon">
                                <i class="${fileIcon}"></i>
                            </div>
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${fileSize}</div>
                            <button class="file-remove" onclick="removeFile(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                });

                previewGrid.innerHTML = html;
            }

            // Función para obtener icono
            function getFileIcon(fileType) {
                if (fileType.startsWith('image/')) {
                    return 'fas fa-file-image';
                } else if (fileType === 'application/pdf') {
                    return 'fas fa-file-pdf';
                } else if (fileType.includes('document') || fileType.includes('msword')) {
                    return 'fas fa-file-word';
                } else if (fileType.includes('text')) {
                    return 'fas fa-file-alt';
                } else {
                    return 'fas fa-file';
                }
            }

            // Función para formatear tamaño
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Actualizar tabla de archivos
            function updateFilesTable() {
                const tableBody = document.getElementById('filesTableBody');
                const tableContainer = document.getElementById('filesTableContainer');

                if (!tableBody || !tableContainer) return;

                if (archivosPendientes.length === 0) {
                    tableContainer.style.display = 'none';
                    tableBody.innerHTML = '';
                    return;
                }

                tableContainer.style.display = 'block';

                let html = '';
                archivosPendientes.forEach((file, index) => {
                    const fileIcon = getFileIcon(file.type);
                    const fileSize = formatFileSize(file.size);
                    const sourceBadge = file.source.includes('Google') ? 'badge-cloud' : 'badge-local';

                    let previewHtml = 'No disponible';
                    if (file.type.startsWith('image/') && file.previewUrl) {
                        previewHtml = `<img src="${file.previewUrl}" class="file-preview-img" alt="Vista previa">`;
                    }

                    html += `
                        <tr>
                            <td>
                                <i class="${fileIcon} mr-2"></i>
                                ${file.name}
                            </td>
                            <td>${file.type || 'Desconocido'}</td>
                            <td>${fileSize}</td>
                            <td>
                                <span class="file-source-badge ${sourceBadge}">
                                    ${file.source}
                                </span>
                            </td>
                            <td>${previewHtml}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="removeFile(${index})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = html;
            }

            // Eliminar un archivo
            function removeFile(index) {
                if (archivosPendientes[index].previewUrl) {
                    URL.revokeObjectURL(archivosPendientes[index].previewUrl);
                }

                archivosPendientes.splice(index, 1);
                updateFilePreview();
                updateFilesTable();
                updateFileCounter();
            }

            // Actualizar contador de archivos
            function updateFileCounter() {
                const counter = document.getElementById('fileCounter');
                const countElement = document.getElementById('fileCount');

                if (counter && countElement) {
                    if (archivosPendientes.length > 0) {
                        counter.style.display = 'inline-flex';
                        countElement.textContent = archivosPendientes.length;
                    } else {
                        counter.style.display = 'none';
                    }
                }
            }

            // Guardar archivos y cerrar modal
            function saveFiles() {
                $('#addPhotoModal').modal('hide');
                updateFileCounter();

                if (archivosPendientes.length > 0) {
                    showToast('success', `${archivosPendientes.length} archivo(s) listo(s) para guardar.`);
                }
            }

            // Mostrar toast
            function showToast(type, message) {
                alert(message);
            }

            ClassicEditor
                .create(document.querySelector('#observacion'))
                .catch(error => {
                    console.error(error);
                });
        </script>
        <script th:inline="javascript">
            // Función para actualizar los tipos de pieza
            function actualizarTipos() {
                var pieza = document.getElementById('pieza').value;
                var contTipo = document.getElementById('container-tipo');
                var selectTipo = document.getElementById('tipo');
                var lista = tiposPorPieza[pieza] || [];

                if (lista.length <= 1 && ['Pulsera','Broche','Otros'].indexOf(pieza) !== -1) {
                    contTipo.style.display = 'none';
                    return;
                } else {
                    contTipo.style.display = 'block';
                }

                selectTipo.innerHTML = '<option value="">-- Selecciona Tipo --</option>';
                lista.forEach(function(t) {
                    var opt = document.createElement('option');
                    opt.value = t;
                    opt.text  = t;
                    selectTipo.add(opt);
                });
            }

            // Al cargar la página, forzar llenado si ya hay valor en pedido.pieza
            document.addEventListener('DOMContentLoaded', function() {
                if (document.getElementById('pieza').value) {
                    actualizarTipos();
                    var tipoActual = /*[[${pedido.tipo}]]*/ '';
                    if (tipoActual) {
                        document.getElementById('tipo').value = tipoActual;
                    }
                }
            });

            // Manejar el envío del formulario principal
            $(document).on('submit', '#pedidoForm', async function(event) {
                event.preventDefault();

                // Deshabilitar botón para evitar doble clic
                $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
                $("#spinnerGuardado").show();

                try {
                    // Procesar archivos antes de enviar (especialmente los de Google Drive)
                    const archivosProcesados = await procesarArchivosParaEnvio();

                    // Crear FormData
                    var formData = new FormData(this);

                    // Añadir archivos procesados al FormData
                    archivosProcesados.forEach(function(file) {
                        formData.append('files', file);
                    });

                    // Enviar el formulario vía AJAX
                    $.ajax({
                        type: 'POST',
                        url: $(this).attr('action'),
                        data: formData,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function(response) {
                            console.log("Respuesta del backend:", response);

                            if (response && response.info) {
                                console.log(response.info);
                            }

                            if (response && response.redirectUrl) {
                                // Limpiar archivos después de guardar exitosamente
                                archivosPendientes.forEach(file => {
                                    if (file.previewUrl) {
                                        URL.revokeObjectURL(file.previewUrl);
                                    }
                                });
                                archivosPendientes = [];
                                updateFileCounter();

                                // Redirigir
                                $.get(response.redirectUrl, function(html) {
                                    var nuevoContenido = $(html).find('#pedidoContent').html();
                                    $('#pedidoContent').html(nuevoContenido);
                                    history.pushState(null, "", response.redirectUrl);
                                    $("#spinnerGuardado").hide();
                                    $('#submitBtn').prop('disabled', false).html(/*[[${titulo}]]*/ 'Guardar');
                                });
                            } else {
                                $("#spinnerGuardado").hide();
                                $('#submitBtn').prop('disabled', false).html(/*[[${titulo}]]*/ 'Guardar');
                                alert("Pedido guardado, pero no se recibió URL de redirección.");
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Error al guardar el pedido:", error);
                            console.error("Respuesta completa:", xhr.responseText);

                            var errorMessage = "Ocurrió un error desconocido al guardar el pedido.";
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                try {
                                    const errorObj = JSON.parse(xhr.responseText);
                                    errorMessage = errorObj.message || errorMessage;
                                } catch (e) {
                                    errorMessage = xhr.responseText.substring(0, 200) + "...";
                                }
                            }

                            $("#spinnerGuardado").hide();
                            $('#submitBtn').prop('disabled', false).html(/*[[${titulo}]]*/ 'Guardar');
                            alert("Error: " + errorMessage);
                        }
                    });
                } catch (error) {
                    console.error("Error al procesar archivos:", error);
                    $("#spinnerGuardado").hide();
                    $('#submitBtn').prop('disabled', false).html(/*[[${titulo}]]*/ 'Guardar');
                    alert("Error al procesar los archivos. Por favor, inténtalo de nuevo.");
                }
            });
        </script>
    </section>
</div>
</body>
</html>