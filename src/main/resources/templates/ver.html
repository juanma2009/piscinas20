<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="admin/admin_layout">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="../css/table.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="../css/table.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>

        .estado-Pendiente { background-color: #f8d7da; }
        .estado-Realizando { background-color: #fff3cd; }
        .estado-Terminado { background-color: #d4edda; }


        .card-header.bg-white {
            background-color: white !important;
        }

        .card-header bg-primary text-white {
            width: 100%;
            height: 100px;
            border-radius: 10px 10px 0 0;
        }
        /* Establecer un padding y margen general para todas las secciones internas */
        .container-fluid,
        .card,
        .card-body,
        .card-header,
        section.content-header {
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* Asegura que las tarjetas no queden pegadas entre s√≠ o a los bordes */
        .card {
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* Control uniforme para las tablas */
        .table {
            margin-bottom: 1rem;
        }

        /* Espaciado entre botones */
        .btn-group .btn {
            margin-right: 0.5rem;
        }

        /* Botones peque√±os con padding uniforme */
        .btn-sm {
            padding: 0.4rem 0.75rem;
        }

        .card-header {
            background: linear-gradient(135deg, #0062cc, #004085); /* Gradiente de azul */
            color: white;
            padding: 15px;
            font-weight: bold;
            text-transform: uppercase; /* Texto en may√∫sculas */
            font-size: 1.25rem; /* Aumentar el tama√±o de la fuente */
            border-radius: 8px 8px 0 0; /* Bordes redondeados */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Sombra ligera */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .card-header:hover {
            background-color: #0056b3; /* Tono m√°s oscuro de azul */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Sombra m√°s pronunciada */
        }

        body {
            width: 100vw;
            min-height: 100vh; /* hace que el body ocupe al menos toda la altura visible */
            overflow-x: hidden;
            background-color: #f9f9f9; /* opcional: fondo m√°s suave */
        }
        body {
            width: 100vw;
            min-height: 100vh; /* hace que el body ocupe al menos toda la altura visible */
            overflow-x: hidden;
            background-color: #f9f9f9; /* opcional: fondo m√°s suave */
        }
        html, body {
            height: 100%; /* Asegura que el contenido cubra toda la pantalla */
            margin: 0; /* Elimina m√°rgenes por defecto */
            padding: 0; /* Elimina el padding por defecto */
            overflow: hidden; /* Oculta el scroll si no es necesario */
        }
        /* Hace la tabla responsiva */
        .table-responsive {
            width: 100%;
            overflow-x: auto;  /* Permite scroll horizontal si es necesario */
            -webkit-overflow-scrolling: touch; /* Mejora el desplazamiento en m√≥viles */
        }

        /* Ajuste general de la tabla */
        .table td, .table th {
            white-space: nowrap; /* Evita que el contenido de las celdas se corte */
            font-size: 14px;
            padding: 8px;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table td,
        .table th {
            white-space: nowrap;
            font-size: 14px;
            padding: 8px;
        }

        @media screen and (min-width: 1268px) {

            html, body {
                overflow-x: hidden;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .container-fluid {
                width: 100%;
                max-width: 100vw;
                padding: 0;
                margin: 0 auto;
                overflow-x: hidden;
            }

            /* Contenedor scrollable de la tabla */
            .dataTables_scrollBody {
                width: 100% !important;
                max-width: 100% !important;


                overflow-y: scroll; /* üîπ Scroll vertical SIEMPRE que sea necesario */
                /*  overflow-x: auto;  üîπ Scroll horizontal solo si se necesita */
                display: block;
            }

            /* Tabla se ajusta al ancho del contenedor sin crecer verticalmente */
            .dataTables_scrollBody table {
                width: 100% !important;
                max-width: 100%;
                min-width: auto !important;
                table-layout: auto;

            }
            .dataTables_scrollBody  th, td {
                padding: 10px;
                white-space: nowrap;
            }

            .card-body{
                margin-top: -35px;
            }
            .dataTables_scrollHeadInner {
                width: 100% !important;
            }

            .dataTables_scrollHeadInner table {
                width: 100% !important;
                table-layout: auto;
            }
            /* Cabecera de la tabla fija al hacer scroll ayuda ha que no este fija*/
            .dataTables_wrapper .dataTables_scroll {
                overflow: auto;
            }

            .dataTables_scrollHeadInner,
            .dataTables_scrollBody table {
                width: 100% !important;
                table-layout: auto;
            }


        .grafico-mismo-alto {
            height: 300px;
        }


        }

    </style>

</head>
<body>

<div layout:fragment="content">
    <div class="container container-fluid">

    <section class="content-header">

          <div class="card">

              <div class="card-header bg-primary text-white">
                  <i class="fas fa-user">
                  </i> Detalles del Cliente <!-- T√≠tulo de la tarjeta -->
              </div>
                <!-- Botones de navegaci√≥n -->
                <div class="row justify-content-between align-items-center">
                    <div class="col-md-8">
                        <div class="btn-group btn-group-toggle">
                            <a th:href="@{/pedidos/listarPedidos}" class="btn btn-outline-primary">
                                <i class="fas fa-list"></i> Pedidos
                            </a>
                            <a th:href="@{/pedidos/listarFotosPedidos}" class="btn btn-outline-primary">
                                <i class="fas fa-images"></i> Galer√≠a
                            </a>
                            <a th:href="@{/listar}" class="btn btn-outline-primary">
                                <i class="fas fa-user"></i> Clientes
                            </a>

                            <a th:href="@{/form}" class="btn btn-outline-primary">
                                <i class="fas fa-user-plus"></i> Nuevo Cliente
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        <!-- Campo oculto que contiene el id del cliente -->
        <input type="hidden" id="clienteId" th:value="${cliente.id}" />

        <div class="card-body">
            <!-- Pesta√±as para Detalles, Pedidos y Facturas -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="cliente-tab" data-toggle="tab" href="#cliente" role="tab" aria-controls="cliente" aria-selected="true">Detalles</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pedidos-tab" data-toggle="tab" href="#pedidos" role="tab" aria-controls="pedidos" aria-selected="false">Pedidos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="albaranes-tab" data-toggle="tab" href="#albaranes" role="tab" aria-controls="albaranes" aria-selected="false">Facturas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="analisis-tab" data-toggle="tab" href="#analisis" role="tab" aria-controls="analisis" aria-selected="false">
                        An√°lisis
                    </a>
                </li>


            </ul>

            <!-- Contenido de las pesta√±as -->
            <div class="tab-content" id="myTabContent">

                <!-- Tab: Detalles (activa por defecto) -->
                <div class="tab-pane fade show active" id="cliente" role="tabpanel" aria-labelledby="cliente-tab">
                    <h4 class="card-title">
                        <!-- Botones para crear facturas, albaranes y pedidos -->
                    </h4>
                    <ul class="list-group">
                        <li class="list-group-item active" th:text="'Datos del Cliente'"></li>
                        <li class="list-group-item" th:text="'Nombre: ' + ${cliente.nombre + cliente.apellido}"></li>
                        <li class="list-group-item" th:text="'Direcci√≥n: ' + ${cliente.direccion}"></li>
                        <li class="list-group-item" th:text="'Tel√©fono: ' + ${cliente.telefono}"></li>
                        <li class="list-group-item" th:text="'Email: ' + ${cliente.email}"></li>
                        <li class="list-group-item" th:text="'Fecha de Alta: ' + ${cliente.createAt}"></li>
                    </ul>
                    <br>
                </div>

                <!-- Tab: Pedidos -->
                <div class="tab-pane fade" id="pedidos" role="tabpanel" aria-labelledby="pedidos-tab">
                    <div class="table-responsive">
                        <table id="table" class="table table-bordered table-striped">
                            <thead class="thead-dark">
                            <tr>
                                <!-- Encabezados de la tabla aqu√≠ -->
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Facturas -->
                <div class="tab-pane fade" id="albaranes" role="tabpanel" aria-labelledby="albaranes-tab">
                    <div class="table-responsive">
                        <table id="tableAlbaran" class="table table-striped table-bordered mt-2">
                            <thead class="thead-dark">
                            <tr>
                                <!-- Encabezados de la tabla aqu√≠ -->
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Datos cargados din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: An√°lisis -->
                <div class="tab-pane fade" id="analisis" role="tabpanel" aria-labelledby="analisis-tab">
                    <div class="row mt-3">

                        <!-- Pedidos por Mes -->
                        <div class="col-md-6 h-100">
                            <div class="card card-primary card-outline h-100">
                                <div class="card-header">
                                    <i class="fas fa-box-open me-2"></i> Pedidos por A√±o
                                </div>
                                <div class="card-body">
                                    <!-- Fila con a√±o a la izquierda y total a la derecha -->
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <!-- Select de a√±o -->
                                        <div class="d-flex align-items-center">
                                            <label for="anioPedidosSelect" class="me-2 mb-0">A√±o:</label>
                                            <select id="anioPedidosSelect" class="form-control form-control-sm">
                                                <!-- Se llenar√° din√°micamente -->
                                            </select>
                                        </div>

                                        <!-- Campo de total pedidos -->
                                        <div class="d-flex align-items-center">
                                            <label for="totalPedidosMensual" class="me-2 fw-bold mb-0">Total Pedidos:</label>
                                            <input type="text" id="totalPedidosMensual" class="form-control form-control-sm text-end" readonly style="width: 100px;">
                                        </div>
                                    </div>

                                    <!-- Gr√°fico -->
                                    <div class="position-relative mb-3 grafico-mismo-alto">
                                        <canvas id="chartPedidosMensual"></canvas>
                                    </div>

                                </div>
                            </div>
                        </div>


                        <!-- Facturaci√≥n Anual -->
                        <div class="col-md-6 h-100">
                            <div class="card card-primary card-outline h-100">
                                <div class="card-header">
                                    <i class="fas fa-euro-sign me-2"></i> Facturaci√≥n Anual
                                </div>
                                <div class="card-body">
                                    <!-- Fila con a√±o a la izquierda y total a la derecha -->
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <!-- Select de a√±o -->
                                        <div class="d-flex align-items-center">
                                        <label for="anioSelect" class="me-2 mb-0">A√±o:</label>
                                            <select id="anioSelect" class="form-control form-control-sm">
                                                <!-- Se llenar√° din√°micamente -->
                                            </select>
                                        </div>
                                        <!-- Campo de total factura -->
                                        <div class="d-flex align-items-center">
                                            <label for="totalFacturacionMensual" class="col-auto col-form-label fw-bold ms-4">Total Facturado:</label>
                                            <input type="text" id="totalFacturacionMensual" class="form-control form-control-sm text-end" readonly style="width: 100px;">
                                        </div>
                                    </div>

                                    <div class="position-relative mb-3 grafico-mismo-alto">
                                        <canvas id="chartFacturacionMensual"></canvas>
                                    </div>


                                </div>

                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>



    </section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>
<script>
    const clienteId = $('#clienteId').val();


    // Variable global para el chart (asumo que la tienes declarada fuera)
    let myChart = null;

    // Arreglo con nombres de meses (o los meses que usas)
    const todosLosMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

    // Variable clienteId, debe estar definida en tu contexto, por ejemplo:
    // const clienteId = 123;

    function cargarAnios() {
        // Llamada GET para obtener los a√±os disponibles para un cliente (como haces con facturas)
        fetch(`/api/pedido/estadisticas/anios-disponibles?clienteId=${clienteId}`)
            .then(response => {
                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                return response.json();
            })
            .then(anios => {
                const select = document.getElementById('anioPedidosSelect');
                select.innerHTML = '';

                if (anios.length === 0) {
                    const option = document.createElement('option');
                    option.text = 'Sin datos';
                    select.appendChild(option);
                    return;
                }

                anios.forEach(anio => {
                    const option = document.createElement('option');
                    option.value = anio;
                    option.text = anio;
                    select.appendChild(option);
                });

                // Seleccionamos el primer a√±o y cargamos sus datos
                select.value = anios[0];
                cargarDatosEstadistica(anios[0]);
            })
            .catch(error => {
                console.error('Error al cargar a√±os:', error);
            });
    }

    function cargarDatosEstadistica(anio) {
        // Llamada GET para obtener datos de pedidos por mes para un a√±o y cliente dados
        fetch(`/api/pedido/estadisticas/pedidos-por-mes?clienteId=${clienteId}&anio=${anio}`)
            .then(response => {
                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                return response.json();
            })
            .then(data => {
                // Obtenemos los valores para cada mes, si no hay datos, ponemos 0
                const valores = todosLosMeses.map(mes => data[mes] || 0);
                const total = valores.reduce((a, b) => a + b, 0);

                // Actualizamos campo total (input o span, seg√∫n como tengas en tu HTML)
                document.getElementById('totalPedidosMensual').value = total;

                const ctx = document.getElementById('chartPedidosMensual').getContext('2d');

                // Si ya hay gr√°fico, lo destruimos para volver a pintar
                if (myChart) {
                    myChart.destroy();
                }

                // Creamos el gr√°fico con Chart.js
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: todosLosMeses,
                        datasets: [{
                            label: `Pedidos en ${anio}`,
                            data: valores,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error al cargar datos del gr√°fico:', error);
            });
    }

    // Evento cambio a√±o: carga datos del a√±o seleccionado
    document.getElementById('anioPedidosSelect').addEventListener('change', function () {
        const anioSeleccionado = this.value;
        cargarDatosEstadistica(anioSeleccionado);
    });

    // Inicializamos la carga de a√±os al cargar la p√°gina
    cargarAnios();



    //factuarci√≥n mensual
    let chartFacturacionMensual; // referencia al gr√°fico para actualizarlo luego

    // 1. Obtener lista de a√±os con facturaci√≥n (una sola vez al cargar)
    $.get(`/api/pedido/estadisticas/anios`, { clienteId }, function (anios) {
        const select = $('#anioSelect');

        anios.forEach(anio => {
            select.append(`<option value="${anio}">${anio}</option>`);
        });

        // Cargar por defecto el √∫ltimo a√±o
        const anioDefault = anios[anios.length - 1];
        select.val(anioDefault);
        cargarFacturacionMensual(anioDefault);
    });

    // 2. Al cambiar el a√±o, volver a cargar la facturaci√≥n
    $('#anioSelect').on('change', function () {
        const anioSeleccionado = $(this).val();
        cargarFacturacionMensual(anioSeleccionado);
    });

    // 3. Funci√≥n para cargar facturaci√≥n mensual y dibujar/actualizar el gr√°fico
    function cargarFacturacionMensual(anio) {
        $.get(`/api/pedido/estadisticas/facturacion-mensual`, { clienteId, anio }, function (data) {
            const labels = Object.keys(data);   // Meses abreviados: Ene, Feb, ...
            const valores = Object.values(data); // Valores de facturaci√≥n

            // Calcular total facturado
            const total = valores.reduce((acc, val) => acc + val, 0);
            $('#totalFacturacionMensual').val(total.toFixed(2) + ' ‚Ç¨');

            // Si el gr√°fico ya existe, actualizarlo
            if (chartFacturacionMensual) {
                chartFacturacionMensual.data.labels = labels;
                chartFacturacionMensual.data.datasets[0].data = valores;
                //chartFacturacionMensual.options.plugins.title.text = `Facturaci√≥n mensual (${anio})`;
                chartFacturacionMensual.update();
            } else {
                // Crear gr√°fico por primera vez
                chartFacturacionMensual = new Chart(document.getElementById('chartFacturacionMensual'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Facturaci√≥n Mensual en (‚Ç¨) del ${anio}`,
                            data: valores,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: false,
                                // text: `Facturaci√≥n mensual (${anio})`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        });
    }


    <!-- inicio de graficos analis-->
    function cargarEstadisticas() {
        // Pedidos por Mes
        $.get('/api/pedido/estadisticas/pedidos-por-mes', { clienteId }, function (data) {
            const labels = Object.keys(data);
            const valores = Object.values(data);
            new Chart(document.getElementById('chartPedidosMes'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pedidos',
                        data: valores,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                }
            });
        });

        // Facturaci√≥n por A√±o
        $.get(`/api/pedido/estadisticas/facturacionanual`, { clienteId }, function (data) {
            const labels = Object.keys(data);
            const valores = Object.values(data);

            // Total de todos los a√±os
            const total = valores.reduce((acc, val) => acc + val, 0);

            // Mostrar el total en la casilla
            $('#totalFacturacion').val(total.toFixed(2) + ' ‚Ç¨');

            new Chart(document.getElementById('chartFacturacionAnual'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Facturaci√≥n (‚Ç¨)',
                        data: valores,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    }]
                }
            });
        });
    }

    function cargarPedidosMensuales(clienteId) {
        const select = document.getElementById('anioPedidosSelect');
        const anio = select.value;

        $.get(`/api/pedido/estadisticas/pedidos-por-mes`, { clienteId, anio }, function (data) {
            const labels = Object.keys(data);
            const valores = Object.values(data);

            const total = valores.reduce((acc, val) => acc + val, 0);
            $('#totalPedidosMensual').val(total);

            if (window.pedidosChart) {
                window.pedidosChart.destroy();
            }

            const ctx = document.getElementById('chartPedidosMensual').getContext('2d');
            window.pedidosChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pedidos',
                        data: valores,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Pedidos: ${context.parsed.y}`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Pedidos por mes (${anio})`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    }
    function llenarAniosPedidos(clienteId) {
        $.get(`/api/pedido/estadisticas/anios-disponibles`, { clienteId }, function (anios) {
            const select = $('#anioPedidosSelect');
            select.empty();
            anios.forEach(anio => {
                select.append(`<option value="${anio}">${anio}</option>`);
            });
            cargarPedidosMensuales(clienteId);
        });
    }

    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        if ($(e.target).attr("href") === '#analisis') {
            cargarEstadisticas();
        }
    });


        let tablaFacturasCargada = true;

        function cargarTablaFacturas() {
            $('#tableAlbaran').DataTable({
                ajax: {
                    url: '/api/factura/listarPorCliente',
                    type: 'GET',
                    data: function (d) {
                        d.clienteId = $('#clienteId').val(); // Aseguramos que sea "clienteId"
                        console.log("Enviando clienteId:", d.clienteId); // Log para depuraci√≥n
                    },
                    dataSrc: function (json) {
                        console.log("Facturas del cliente:", json);
                        if (json.data) return json.data;
                        if (json.factura?.content) return json.factura.content;
                        return [];
                    },
                    error: function (xhr, status, error) {
                        console.error("Error al cargar facturas:", error);
                        console.error("Respuesta del servidor:", xhr.responseText);
                    }
                },
                columns: [
                    { data: 'id', title: 'N¬∞ Factura' },
                    {
                        data: 'dfechaAlbaran',
                        title: 'F. Factura',
                        render: function (data) {
                            if (!data) return '';
                            const date = new Date(data);
                            return date.toLocaleDateString('es-ES'); // dd/mm/yyyy
                        }
                    },
                    { data: 'tipoPedido', title: 'Tipo de Pedido' },
                    {
                        data: 'subTotal',
                        title: 'Total',
                        render: function (data) {
                            return parseFloat(data).toFixed(2) + ' ‚Ç¨';
                        }
                    },
                    {
                        data: 'id',
                        title: 'Acciones',
                        orderable: false,
                        searchable: false,
                        className: 'text-center',
                        render: function (data) {
                            return `

          <a href="/facturas/ver/${data}" class="btn btn-info btn-sm" title="Ver factura">
            <i class="fas fa-eye"></i>
          </a>
          <a href="/facturas/formEditar/${data}" class="btn btn-warning btn-sm" title="Editar factura">
            <i class="fas fa-pencil-alt"></i>
          </a>

      `;
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                },
                paging: true,
                searching: true,
                ordering: true,
                lengthMenu: [5, 10, 15, 25],
                pageLength: 5,
                displayLength: 5,
                fixedHeader: true,
                scrollY: "300px",
                scrollCollapse: true,
                responsive: true
            });
        }



        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr("href");
        if (target === '#albaranes' && !tablaFacturasCargada) {
        cargarTablaFacturas();
        tablaFacturasCargada = true;
    }
    });


        $(document).ready(function() {
            const idcliente = $('#clienteId').val();

            $('#table').DataTable({
                ajax: {
                    url: '/api/pedido/listarPedidosClientes',
                    type: 'GET',
                    data: d => {
                        d.idCliente = idcliente;
                    },
                    dataSrc: json => json.data
                        ?? json.pedido?.content
                        ?? [],
                },
                "columns": [
                    {"data": "ref", "title": "N¬∞ Ref"},

                    {"data": "tipoPedido", "title": "T.Pedido"},
                    {"data": "estado", "title": "Estado"},
                    {
                        "data": "fechaEntrega",
                        "title": "F.Entrega",

                        "render": function (data, type, row) {
                            if (!data) return ""; // Evitar errores si la fecha es nula
                            const fecha = new Date(data);
                            const dia = String(fecha.getDate()).padStart(2, '0');
                            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                            const anio = fecha.getFullYear();
                            return `${dia}-${mes}-${anio}`;
                        }
                    },
                    {
                        "data": "fechaFinalizado",
                        "title": "F.Finalizado",
                        "render": function (data, type, row) {
                            if (!data) return "";
                            const fecha = new Date(data);
                            const dia = String(fecha.getDate()).padStart(2, '0');
                            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                            const anio = fecha.getFullYear();
                            return `${dia}-${mes}-${anio}`;
                        }
                    }
                    ,


                    {"data": "metal", "title": "Metal"},
                    {"data": "pieza", "title": "Pieza"},
                    {"data": "tipo", "title": "Tipo"},
                    {"data": "cobrado", "title": "Cobrado"},
                    /* {
                         "data": "imageUrl",
                         "title": "Imagen",
                        /* "render": function(data) {
                             return `<img src="${data}" width="50" height="50" onerror="this.src='/img/default.jpg'">`;
                         }
                     },*/
                    {
                        "data": "npedido",
                        "title": "Acciones",
                        "render": function (data) {
                            return `
            <a href="/pedidos/ver/${data}" class="btn btn-info btn-sm" title="Ver pedido">
                <i class="fas fa-eye"></i>
            </a>
            <a href="/pedidos/formEditar/${data}" class="btn btn-warning btn-sm" title="Editar pedido">
                <i class="fas fa-pencil-alt"></i>
            </a>
        `;
                        }
                    }


                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json"
                }, //la cabezer se mueve tambien con el scroll
                paging: true,
                searching: true,
                ordering: true,
                lengthMenu: [5, 10, 15, 25],
                pageLength: 5,
                scrollY: "300px",          // Scroll vertical
                scrollX: true,             // üîπ Scroll horizontal sincroniza <thead> y <tbody>
                scrollCollapse: true,
                fixedHeader: false,        // Aseg√∫rate de que no est√© activo si no quieres cabecera fija al hacer scroll vertical
                responsive: false
            });
        });
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function () {
            table.columns.adjust().draw();
        });

        // Chart Pedidos por Mes (√∫ltimos 12 meses)
        const pedidosMesChart = new Chart(document.getElementById(' '), {
            type: 'bar',
            data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                datasets: [{
                    label: 'Pedidos',
                    data: data, // Reemplaza por datos reales
                    backgroundColor: 'rgba(54, 162, 235, 0.6)'
                }]
            }
        });

        // Chart Facturaci√≥n Anual
        const facturacionAnualChart = new Chart(document.getElementById('chartFacturacionAnual'), {
            type: 'line',
            data: {
                labels: ['2021', '2022', '2023', '2024'],
                datasets: [{
                    label: 'Total Facturado (‚Ç¨)',
                    data: data ,// Reemplaza por datos reales
                    borderColor: 'rgba(255, 99, 132, 1)',
                    fill: false
                }]
            }
        });


</script>

