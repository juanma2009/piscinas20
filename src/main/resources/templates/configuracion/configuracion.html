<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="admin/admin_layout">
<head>
    <meta charset="UTF-8">
    <title>Configuración de Listados</title>
</head>

<body>
<div layout:fragment="content">
    <div class="container-fluid px-2 px-md-3">
        <div id="globalMessage"></div>
        <section class="content-header">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cog mr-2"></i> Configuración de Listados
                </div>

                <div class="toolbar">
                    <a th:href="@{/pedidos/listarFotosPedidos}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-images mr-1"></i> Galería
                    </a>
                    <a th:href="@{/listar}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-users mr-1"></i> Clientes
                    </a>
                    <a th:href="@{/form}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-user-plus mr-1"></i> Nuevo Cliente
                    </a>
                </div>

                <div class="card-body">
                    <!-- Nav Tabs -->
                    <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-toggle="tab" data-target="#servicios">Servicios</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-toggle="tab" data-target="#metales">Metales</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-toggle="tab" data-target="#subgrupos">Subgrupos</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-toggle="tab" data-target="#estados">Estados</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Dynamic Sections -->
                        <div class="tab-pane fade show active" id="servicios"></div>
                        <div class="tab-pane fade" id="metales"></div>
                        <div class="tab-pane fade" id="subgrupos"></div>
                        <div class="tab-pane fade" id="estados"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Generic Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Añadir / Editar</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="modalNombre" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <input type="text" class="form-control" id="modalDescripcion">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CARD BASE TEMPLATE -->
    <template id="card-template">
        <div class="card border shadow-none mb-0">
            <div class="card-header bg-light text-dark d-flex justify-content-between align-items-center" style="background: #f8f9fa !important; color: #333 !important; text-transform: none !important; border-bottom: 1px solid #dee2e6 !important;">
                <h5 class="mb-0 font-weight-bold" style="font-size: 1.1rem;"></h5>
                <button class="btn btn-sm btn-success" data-action="add">
                    <i class="fas fa-plus mr-1"></i> Añadir
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped w-100 mb-0">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
</div>

<div layout:fragment="script">
    <script th:inline="javascript">
        (function() {
            const tipos = ['servicios', 'metales', 'subgrupos', 'estados'];
            const $modal = $('#configModal');
            const modalForm = $modal.find('form');
            let current = { tipo: null, id: null };
            let tables = {};

            function renderSection(tipo) {
                const container = $(`#${tipo}`);
                container.empty();
                const template = document.getElementById('card-template');
                const clone = document.importNode(template.content, true);
                const $card = $(clone.firstElementChild);

                $card.find('h5').text(tipo.charAt(0).toUpperCase() + tipo.slice(1));

                const table = $card.find('table').DataTable({
                    ajax: { url: `/api/configuracion/${tipo}`, dataSrc: (json) => json },
                    columns: [
                        { data: 'nombre' },
                        { data: 'description', defaultContent: '' },
                        {
                            data: 'id',
                            orderable: false,
                            className: 'text-center',
                            render: id => `
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary mr-1" data-action="edit" data-id="${id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" data-action="del" data-id="${id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>`
                        }
                    ],
                    language: { url: "//cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json" },
                    pageLength: 10,
                    lengthMenu: [10, 25, 50],
                    autoWidth: false,
                    scrollX: true
                });

                tables[tipo] = table;

                $card.find('[data-action=add]').on('click', () => {
                    current = { tipo, id: null };
                    modalForm[0].reset();
                    $modal.find('.modal-title').text(`Añadir a ${tipo}`);
                    $modal.modal('show');
                });

                $card.on('click', '[data-action=edit]', function() {
                    const id = $(this).data('id');
                    const data = table.row($(this).closest('tr')).data();
                    current = { tipo, id };
                    $('#modalNombre').val(data.nombre);
                    $('#modalDescripcion').val(data.description);
                    $modal.find('.modal-title').text(`Editar en ${tipo}`);
                    $modal.modal('show');
                });

                $card.on('click', '[data-action=del]', function() {
                    const id = $(this).data('id');
                    if (confirm('¿Estás seguro de eliminar este elemento?')) {
                        $.ajax({
                            url: `/api/configuracion/${tipo}/${id}`,
                            type: 'DELETE',
                            success: () => {
                                table.ajax.reload();
                                showAlert('Elemento eliminado correctamente', 'success');
                            },
                            error: () => showAlert('Error al eliminar el elemento', 'danger')
                        });
                    }
                });

                container.append($card);
            }

            modalForm.on('submit', function(e) {
                e.preventDefault();
                const data = {
                    nombre: $('#modalNombre').val(),
                    description: $('#modalDescripcion').val()
                };
                if (current.id) data.id = current.id;

                $.ajax({
                    url: `/api/configuracion/${current.tipo}`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: () => {
                        $modal.modal('hide');
                        tables[current.tipo].ajax.reload();
                        showAlert('Guardado correctamente', 'success');
                    },
                    error: () => showAlert('Error al guardar', 'danger')
                });
            });

            function showAlert(msg, type) {
                const alert = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${msg}
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                </div>`;
                $('#globalMessage').html(alert);
                setTimeout(() => $('.alert').alert('close'), 3000);
            }

            $(document).ready(() => {
                tipos.forEach(renderSection);
                // Fix for DataTable responsiveness on tab change
                $('button[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                    $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
                });
            });
        })();
    </script>
</div>
</body>
</html>
