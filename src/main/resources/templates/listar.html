<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="admin/admin_layout.html">

<head>
	<meta charset="utf-8"/>
	<title>Listado de Clientes</title>

	<!-- Solo CSS propio (jQuery/Bootstrap/DataTables ya vienen del layout) -->
	<link rel="stylesheet" th:href="@{/css/table.css}"/>

</head>

<div layout:fragment="content">
	<div class="container-fluid px-2 px-md-3">
		<section class="content-header">
			<div class="card">

				<div class="card-header">
					<i class="fas fa-users mr-2"></i> Listado de Clientes
				</div>

				<div class="toolbar">
					<a th:href="@{/pedidos/listarPedidos}" class="btn btn-outline-primary btn-sm">
						<i class="fas fa-list mr-1"></i> Pedidos
					</a>
					<a th:href="@{/pedidos/listarFotosPedidos}" class="btn btn-outline-primary btn-sm">
						<i class="fas fa-images mr-1"></i> Galería
					</a>
					<a th:href="@{/form}" class="btn btn-outline-primary btn-sm">
						<i class="fas fa-user-plus mr-1"></i> Nuevo Cliente
					</a>
				</div>

				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-striped table-bordered datatable w-100"
							   id="tablaClientes"
							   data-dt="auto"
							   data-dt-hide-mobile="2,3,4">

							<thead class="table-dark text-center align-middle">
							<tr>
								<th>Detalles</th>
								<th>Nombre</th>
								<th class="col-hide-mobile">Email</th>
								<th class="col-hide-mobile">Teléfono</th>
								<th class="col-hide-mobile">Dirección</th>
								<th>Acciones</th>
							</tr>
							</thead>

							<!-- ✅ MANTENIDO: datos salen del model (NO AJAX) -->
							<tbody>
							<tr th:each="cliente : ${clientes}">
								<td class="text-center">
									<a class="btn btn-outline-primary btn-sm"
									   th:href="@{/ver/} + ${cliente.id}"
									   title="Ver Detalles">
										<i class="fas fa-eye"></i>
									</a>
								</td>
								<td th:text="${cliente.nombre} + ' ' + ${cliente.apellido}"></td>
								<td th:text="${cliente.email}"></td>
								<td th:text="${cliente.telefono}"></td>
								<td th:text="${cliente.direccion}"></td>

								<td class="text-center">
									<div style="display:flex; gap:.35rem; flex-wrap:wrap; justify-content:center;">
										<a class="btn btn-outline-success btn-sm"
										   th:href="@{'/pedidos/form/' + ${cliente.id}}"
										   title="Nuevo Pedido">
											<i class="fas fa-plus-circle"></i>
										</a>

										<a class="btn btn-outline-secondary btn-sm albaran-modal-btn"
										   data-toggle="modal" data-target="#albaranesModal"
										   th:data-cliente-id="${cliente.id}" title="Ver Facturas">
											<i class="fas fa-file-invoice"></i>
										</a>

										<a class="btn btn-outline-primary btn-sm"
										   th:href="@{/form/} + ${cliente.id}" title="Editar Cliente">
											<i class="fas fa-edit"></i>
										</a>
									</div>
								</td>
							</tr>
							</tbody>
						</table>
					</div>
				</div><!-- /card-body -->
			</div><!-- /card -->
		</section>
	</div>
</div>

<!-- Modal -->
<div class="modal fade" id="albaranesModal" tabindex="-1" role="dialog" aria-labelledby="albaranesModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="albaranesModalLabel">Pedidos Finalizados</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<div class="modal-body">
				<p class="text-muted mb-0">Cargando...</p>
			</div>

			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
			</div>
		</div>
	</div>
</div>

<div layout:fragment="script">
	<script>
		$(document).ready(function () {

			// ✅ Modal facturas (esto sí es AJAX, solo para el modal)
			$('.albaran-modal-btn').click(function () {
				var clienteId = $(this).data('cliente-id');

				$.ajax({
					type: "GET",
					url: "/api/pedido/listarPedidos/" + clienteId,
					success: function (response) {
						tableModal(response);
					},
					error: function (xhr, status, error) {
						console.error(xhr.responseText, status, error);
						$('#albaranesModal .modal-body').html('<div class="alert alert-danger">Error cargando pedidos.</div>');
					}
				});
			});

			function tableModal(response) {
				if (!response || response.length === 0) {
					$('#albaranesModal .modal-body').html('<p>No existen pedidos finalizados para este cliente.</p>');
					return;
				}

				let tableHtml = `
                    <table class="table table-bordered table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

				response.forEach(pedido => {
					tableHtml += `
                        <tr>
                            <td>${pedido.id ?? ""}</td>
                            <td>${pedido.fecha ?? ""}</td>
                            <td>${pedido.total ?? ""}</td>
                            <td>${pedido.estado ?? ""}</td>
                            <td>
                                <a href="/pedidos/ver/${pedido.id}" class="btn btn-sm btn-outline-primary" title="Ver Pedido">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                    `;
				});

				tableHtml += `</tbody></table>`;
				$('#albaranesModal .modal-body').html(tableHtml);
			}
		});
	</script>
</div>

</html>
